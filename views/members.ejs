<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó‡∏ô‡πâ‡∏≠‡∏á‡∏Ñ‡∏∏‡∏°‡∏∞ üê±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Quill.js Rich Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
    <style>
        * {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 30%, #fff1f2 60%, #fef9c3 100%);
            min-height: 100vh;
        }

        /* Auth Card */
        .auth-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 2px solid #fecdd3;
            border-radius: 2rem;
            box-shadow: 0 20px 60px rgba(253, 164, 175, 0.15);
        }

        .auth-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #fecdd3;
            border-radius: 1rem;
            outline: none;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: #fff5f5;
        }

        .auth-input:focus {
            border-color: #fb7185;
            box-shadow: 0 0 0 3px rgba(251, 113, 133, 0.15);
            background: white;
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            border-radius: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 1rem;
        }

        .auth-btn-primary {
            background: linear-gradient(135deg, #fb7185, #f43f5e);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 63, 94, 0.3);
        }

        .auth-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 63, 94, 0.4);
        }

        .auth-btn-google {
            background: white;
            color: #374151;
            border: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .auth-btn-google:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .auth-link {
            color: #f43f5e;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        /* Members Area */
        .member-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border: 2px solid #fecdd3;
            border-radius: 1.5rem;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        .member-card:hover {
            box-shadow: 0 8px 30px rgba(253, 164, 175, 0.2);
            transform: translateY(-2px);
        }

        /* Note Cards */
        .note-card {
            background: white;
            border: 2px solid #fed7aa;
            border-radius: 1rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .note-card:hover {
            border-color: #fb923c;
            box-shadow: 0 4px 15px rgba(251, 146, 60, 0.15);
            transform: translateY(-2px);
        }

        .note-card.active {
            border-color: #f43f5e;
            background: #fff1f2;
        }

        /* Quill Editor Override */
        .ql-container {
            border-radius: 0 0 1rem 1rem;
            border-color: #fecdd3 !important;
            min-height: 250px;
            font-family: 'Noto Sans Thai', sans-serif;
        }

        .ql-toolbar {
            border-radius: 1rem 1rem 0 0;
            border-color: #fecdd3 !important;
            background: #fff5f5;
        }

        .ql-editor {
            min-height: 250px;
        }

        /* Drawing Canvas */
        #drawingCanvas {
            border: 2px dashed #fecdd3;
            border-radius: 1rem;
            cursor: crosshair;
            background: white;
        }

        /* Sidebar nav */
        .nav-item {
            padding: 10px 16px;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-item:hover {
            background: #ffe4e6;
        }

        .nav-item.active {
            background: #fda4af;
            color: white;
        }

        /* Toast */
        .toast-msg {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 1rem;
            font-weight: 600;
            z-index: 9999;
            animation: slideUp 0.3s ease, fadeOut 0.3s 2.5s ease forwards;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.15);
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Drawing toolbar */
        .draw-tool {
            padding: 6px 12px;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            background: white;
        }

        .draw-tool:hover {
            border-color: #fb7185;
        }

        .draw-tool.active {
            background: #fb7185;
            color: white;
            border-color: #fb7185;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <!-- ==================== AUTH SCREEN ==================== -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="auth-card p-8 max-w-md w-full">
            <!-- Login Form -->
            <div id="loginForm">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">üê±üîê</div>
                    <h1 class="text-2xl font-bold text-rose-500">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó‡∏ô‡πâ‡∏≠‡∏á‡∏Ñ‡∏∏‡∏°‡∏∞</h1>
                    <p class="text-rose-300 text-sm mt-1">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©!</p>
                </div>
                <div class="space-y-4">
                    <input type="email" id="loginEmail" class="auth-input" placeholder="üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                    <input type="password" id="loginPassword" class="auth-input" placeholder="üîí ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                    <button onclick="doLogin()" class="auth-btn auth-btn-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡πÄ‡∏°‡∏µ‡πâ‡∏¢‡∏ß üêæ</button>
                    <div class="flex items-center gap-3 my-2">
                        <div class="flex-1 h-px bg-rose-200"></div>
                        <span class="text-rose-300 text-xs">‡∏´‡∏£‡∏∑‡∏≠</span>
                        <div class="flex-1 h-px bg-rose-200"></div>
                    </div>
                    <button onclick="doGoogleLogin()" class="auth-btn auth-btn-google">
                        <svg width="20" height="20" viewBox="0 0 48 48">
                            <path fill="#EA4335"
                                d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z" />
                            <path fill="#4285F4"
                                d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z" />
                            <path fill="#FBBC05"
                                d="M10.53 28.59a14.5 14.5 0 010-9.18l-7.98-6.19a24.01 24.01 0 000 21.56l7.98-6.19z" />
                            <path fill="#34A853"
                                d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z" />
                        </svg>
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
                    </button>
                </div>
                <div class="flex justify-between mt-6">
                    <span class="auth-link" onclick="showForm('register')">üìù ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
                    <span class="auth-link" onclick="showForm('forgot')">üîë ‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</span>
                </div>
                <div class="text-center mt-4">
                    <a href="/" class="text-rose-300 text-sm hover:text-rose-500 transition-colors">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
                </div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">üê±‚ú®</div>
                    <h1 class="text-2xl font-bold text-rose-500">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏°‡∏∞!</h1>
                    <p class="text-rose-300 text-sm mt-1">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏µ‡∏°</p>
                </div>
                <div class="space-y-4">
                    <input type="text" id="regDisplayName" class="auth-input"
                        placeholder="üò∏ ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á (Display Name)">
                    <input type="email" id="regEmail" class="auth-input" placeholder="üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                    <input type="password" id="regPassword" class="auth-input"
                        placeholder="üîí ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß)">
                    <input type="password" id="regPasswordConfirm" class="auth-input" placeholder="üîí ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                    <button onclick="doRegister()" class="auth-btn auth-btn-primary">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡πÄ‡∏°‡∏µ‡πâ‡∏¢‡∏ß üêæ</button>
                </div>
                <div class="text-center mt-4">
                    <span class="auth-link" onclick="showForm('login')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login</span>
                </div>
            </div>

            <!-- Forgot Password Form -->
            <div id="forgotForm" class="hidden">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">üîëüòø</div>
                    <h1 class="text-2xl font-bold text-rose-500">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h1>
                    <p class="text-rose-300 text-sm mt-1">‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</p>
                </div>
                <div class="space-y-4">
                    <input type="email" id="forgotEmail" class="auth-input" placeholder="üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£">
                    <button onclick="doForgotPassword()" class="auth-btn auth-btn-primary">‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï üìß</button>
                </div>
                <div class="text-center mt-4">
                    <span class="auth-link" onclick="showForm('login')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login</span>
                </div>
            </div>

            <!-- Change Password Form -->
            <div id="changePassForm" class="hidden">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">üîêüîÑ</div>
                    <h1 class="text-2xl font-bold text-rose-500">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h1>
                </div>
                <div class="space-y-4">
                    <input type="password" id="oldPassword" class="auth-input" placeholder="üîí ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°">
                    <input type="password" id="newPassword" class="auth-input" placeholder="üîë ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                    <input type="password" id="newPasswordConfirm" class="auth-input"
                        placeholder="üîë ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                    <button onclick="doChangePassword()" class="auth-btn auth-btn-primary">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô üîÑ</button>
                </div>
                <div class="text-center mt-4">
                    <span class="auth-link" onclick="showForm('login')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login</span>
                    <span id="backToMembersLink" class="auth-link hidden ml-4" onclick="backToMembers()">‚Üê
                        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
                </div>
            </div>

            <!-- Error/Success Message -->
            <div id="authMessage" class="hidden mt-4 p-3 rounded-xl text-center text-sm font-medium"></div>
        </div>
    </div>

    <!-- ==================== MEMBERS AREA (Hidden until login) ==================== -->
    <div id="membersArea" class="hidden min-h-screen">
        <!-- Top Bar -->
        <div
            class="bg-white/80 backdrop-blur-lg border-b-2 border-rose-200 px-6 py-3 flex justify-between items-center sticky top-0 z-50">
            <div class="flex items-center gap-3">
                <a href="/" class="text-rose-400 hover:text-rose-600 text-sm font-medium">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
                <span class="text-rose-200">|</span>
                <span class="text-lg">üê±</span>
                <span class="font-bold text-rose-500">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó‡∏ô‡πâ‡∏≠‡∏á‡∏Ñ‡∏∏‡∏°‡∏∞</span>
            </div>
            <div class="flex items-center gap-3">
                <span id="userDisplayName" class="text-sm text-gray-600 font-medium"></span>
                <img id="userAvatar" src="" class="w-8 h-8 rounded-full border-2 border-rose-300 hidden" alt="avatar">
                <button onclick="doLogout()"
                    class="bg-rose-100 text-rose-500 px-4 py-2 rounded-xl text-sm font-bold hover:bg-rose-200 transition-colors">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö üö™
                </button>
            </div>
        </div>

        <div class="max-w-7xl mx-auto p-6 flex gap-6">
            <!-- Left Sidebar Nav -->
            <div class="w-56 shrink-0">
                <div class="member-card sticky top-20">
                    <div class="text-center mb-4">
                        <img id="sidebarAvatar"
                            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23fda4af'/%3E%3Ctext x='50' y='60' text-anchor='middle' font-size='40'%3Eüê±%3C/text%3E%3C/svg%3E"
                            class="w-16 h-16 rounded-full mx-auto border-3 border-rose-300 mb-2" alt="">
                        <p id="sidebarName" class="font-bold text-rose-500 text-sm"></p>
                        <p id="sidebarEmail" class="text-xs text-gray-400"></p>
                    </div>
                    <hr class="border-rose-100 mb-3">
                    <div class="space-y-1">
                        <div class="nav-item active" onclick="showSection('notes')">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Notes</div>
                        <div class="nav-item" onclick="showSection('profile')">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</div>
                        <div class="nav-item" onclick="showChangePasswordModal()">
                            üîê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="flex-1">
                <!-- Notes Section -->
                <div id="sectionNotes">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-rose-500">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Notes ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                        <button onclick="createNewNote()"
                            class="bg-gradient-to-r from-rose-400 to-orange-400 text-white px-5 py-2 rounded-xl font-bold text-sm hover:shadow-lg transition-all hover:-translate-y-0.5">
                            ‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á Note ‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>

                    <!-- Note List -->
                    <div id="noteList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <div class="text-center py-10 text-rose-200 col-span-full">
                            <div class="text-5xl mb-2">üìã</div>
                            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Note ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡πÄ‡∏•‡∏¢!</p>
                        </div>
                    </div>

                    <!-- Note Editor (hidden by default) -->
                    <div id="noteEditor" class="hidden member-card">
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" id="noteTitle" placeholder="‚úèÔ∏è ‡∏ä‡∏∑‡πà‡∏≠ Note..."
                                class="text-xl font-bold text-rose-500 bg-transparent border-none outline-none flex-1"
                                value="">
                            <div class="flex gap-2">
                                <button onclick="saveCurrentNote()"
                                    class="bg-green-100 text-green-600 px-4 py-2 rounded-xl text-sm font-bold hover:bg-green-200 transition-colors">üíæ
                                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                <button onclick="closeEditor()"
                                    class="bg-gray-100 text-gray-500 px-4 py-2 rounded-xl text-sm font-bold hover:bg-gray-200 transition-colors">‚úï
                                    ‡∏õ‡∏¥‡∏î</button>
                            </div>
                        </div>

                        <!-- Editor Tabs -->
                        <div class="flex gap-2 mb-4">
                            <button onclick="switchEditorTab('write')" id="tabWrite" class="draw-tool active">üìù
                                ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</button>
                            <button onclick="switchEditorTab('draw')" id="tabDraw" class="draw-tool">üé® ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ</button>
                            <button onclick="switchEditorTab('attach')" id="tabAttach" class="draw-tool">üìé
                                ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå</button>
                        </div>

                        <!-- Write Tab -->
                        <div id="editorWrite">
                            <div id="quillEditor"></div>
                        </div>

                        <!-- Draw Tab -->
                        <div id="editorDraw" class="hidden">
                            <div class="flex gap-2 mb-3 flex-wrap">
                                <button onclick="setDrawTool('pen')" class="draw-tool active" id="toolPen">‚úèÔ∏è
                                    ‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤</button>
                                <button onclick="setDrawTool('eraser')" class="draw-tool" id="toolEraser">üßπ ‡∏•‡∏ö</button>
                                <button onclick="setDrawTool('rect')" class="draw-tool" id="toolRect">‚¨ú
                                    ‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°</button>
                                <button onclick="setDrawTool('circle')" class="draw-tool" id="toolCircle">‚≠ï
                                    ‡∏ß‡∏á‡∏Å‡∏•‡∏°</button>
                                <button onclick="setDrawTool('arrow')" class="draw-tool" id="toolArrow">‚û°Ô∏è
                                    ‡∏•‡∏π‡∏Å‡∏®‡∏£</button>
                                <button onclick="setDrawTool('text')" class="draw-tool" id="toolText">üî§
                                    ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
                                <input type="color" id="drawColor" value="#f43f5e"
                                    class="w-8 h-8 rounded cursor-pointer border-2 border-gray-200">
                                <select id="drawSize" class="border-2 border-gray-200 rounded px-2 text-sm">
                                    <option value="2">‡πÄ‡∏™‡πâ‡∏ô‡∏ö‡∏≤‡∏á</option>
                                    <option value="4" selected>‡∏õ‡∏Å‡∏ï‡∏¥</option>
                                    <option value="8">‡∏´‡∏ô‡∏≤</option>
                                    <option value="12">‡∏´‡∏ô‡∏≤‡∏°‡∏≤‡∏Å</option>
                                </select>
                                <button onclick="clearCanvas()" class="draw-tool">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á</button>
                                <button onclick="undoCanvas()" class="draw-tool">‚Ü©Ô∏è Undo</button>
                            </div>
                            <canvas id="drawingCanvas" width="800" height="500"></canvas>
                        </div>

                        <!-- Attach Tab -->
                        <div id="editorAttach" class="hidden">
                            <div class="border-2 border-dashed border-rose-200 rounded-xl p-8 text-center cursor-pointer hover:border-rose-400 transition-colors"
                                onclick="document.getElementById('fileUploadInput').click()">
                                <div class="text-4xl mb-2">üìÇ</div>
                                <p class="text-rose-400 font-medium">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</p>
                                <p class="text-rose-300 text-xs mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡πÑ‡∏ü‡∏•‡πå, ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û, ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10MB)</p>
                                <input type="file" id="fileUploadInput" class="hidden" multiple
                                    accept="image/*,video/*,.pdf,.doc,.docx,.txt" onchange="handleFileUpload(this)">
                            </div>
                            <div id="attachmentList" class="mt-4 space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="sectionProfile" class="hidden">
                    <h2 class="text-2xl font-bold text-rose-500 mb-6">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h2>
                    <div class="member-card max-w-lg">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-rose-500 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</label>
                                <input type="text" id="profileName" class="auth-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-rose-500 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                                <input type="email" id="profileEmail" class="auth-input" disabled style="opacity:0.6">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-rose-500 mb-1">‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (URL)</label>
                                <input type="text" id="profilePhoto" class="auth-input"
                                    placeholder="https://example.com/photo.jpg">
                            </div>
                            <button onclick="saveProfile()" class="auth-btn auth-btn-primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal (overlay on members area) -->
    <div id="changePassModal" class="hidden modal-overlay">
        <div class="modal-content max-w-md">
            <div class="text-center mb-6">
                <div class="text-5xl mb-2">üîêüîÑ</div>
                <h1 class="text-2xl font-bold text-rose-500">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h1>
            </div>
            <div class="space-y-4">
                <input type="password" id="modalOldPassword" class="auth-input" placeholder="üîí ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°">
                <input type="password" id="modalNewPassword" class="auth-input" placeholder="üîë ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                <input type="password" id="modalNewPasswordConfirm" class="auth-input"
                    placeholder="üîë ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                <button onclick="doChangePasswordModal()" class="auth-btn auth-btn-primary">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô üîÑ</button>
            </div>
            <div id="modalChangePassMsg" class="hidden mt-4 p-3 rounded-xl text-center text-sm font-medium"></div>
            <div class="text-center mt-4">
                <span class="auth-link" onclick="closeChangePasswordModal()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAk4mKgcX33bl-z35AB0J-2KHq7aicLnv0",
            authDomain: "kuma-project-5d48d.firebaseapp.com",
            projectId: "kuma-project-5d48d",
            storageBucket: "kuma-project-5d48d.firebasestorage.app",
            messagingSenderId: "144116159091",
            appId: "1:144116159091:web:44ea6d2773c98b464c5006",
            measurementId: "G-8S286PK7LT"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ==================== AUTH FUNCTIONS ====================
        function showForm(form) {
            ['loginForm', 'registerForm', 'forgotForm', 'changePassForm'].forEach(f => document.getElementById(f).classList.add('hidden'));
            document.getElementById(form + (form === 'login' ? 'Form' : form === 'register' ? 'Form' : form === 'forgot' ? 'Form' : 'Form')).classList.remove('hidden');
            const formMap = { login: 'loginForm', register: 'registerForm', forgot: 'forgotForm', changePass: 'changePassForm' };
            document.getElementById(formMap[form]).classList.remove('hidden');
            hideAuthMessage();
        }

        function showAuthMessage(msg, isError = false) {
            const el = document.getElementById('authMessage');
            el.textContent = msg;
            el.className = `mt-4 p-3 rounded-xl text-center text-sm font-medium ${isError ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-600'}`;
            el.classList.remove('hidden');
        }
        function hideAuthMessage() { document.getElementById('authMessage').classList.add('hidden'); }

        async function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const pass = document.getElementById('loginPassword').value;
            if (!email || !pass) return showAuthMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', true);
            try {
                await auth.signInWithEmailAndPassword(email, pass);
                showAuthMessage('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏°‡∏µ‡πâ‡∏¢‡∏ß üêæ');
            } catch (e) {
                showAuthMessage(getErrorMessage(e.code), true);
            }
        }

        async function doGoogleLogin() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (e) {
                showAuthMessage(getErrorMessage(e.code), true);
            }
        }

        async function doRegister() {
            const name = document.getElementById('regDisplayName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pass = document.getElementById('regPassword').value;
            const pass2 = document.getElementById('regPasswordConfirm').value;
            if (!name || !email || !pass) return showAuthMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', true);
            if (pass !== pass2) return showAuthMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', true);
            if (pass.length < 6) return showAuthMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß', true);
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                await cred.user.updateProfile({ displayName: name });
                showAuthMessage('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà üê±‚ú®');
            } catch (e) {
                showAuthMessage(getErrorMessage(e.code), true);
            }
        }

        async function doForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();
            if (!email) return showAuthMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•', true);
            try {
                await auth.sendPasswordResetEmail(email);
                showAuthMessage('‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß! üìß ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏µ‡πâ‡∏¢‡∏ß');
            } catch (e) {
                showAuthMessage(getErrorMessage(e.code), true);
            }
        }

        async function doChangePassword() {
            const oldPass = document.getElementById('oldPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const newPass2 = document.getElementById('newPasswordConfirm').value;
            if (!oldPass || !newPass) return showAuthMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', true);
            if (newPass !== newPass2) return showAuthMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', true);
            if (newPass.length < 6) return showAuthMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß', true);
            try {
                const user = auth.currentUser;
                const cred = firebase.auth.EmailAuthProvider.credential(user.email, oldPass);
                await user.reauthenticateWithCredential(cred);
                await user.updatePassword(newPass);
                showAuthMessage('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üîê‚úÖ');
            } catch (e) {
                showAuthMessage(getErrorMessage(e.code), true);
            }
        }

        function doLogout() {
            auth.signOut();
        }

        // ==================== CHANGE PASSWORD MODAL ====================
        function showChangePasswordModal() {
            document.getElementById('changePassModal').classList.remove('hidden');
            document.getElementById('modalOldPassword').value = '';
            document.getElementById('modalNewPassword').value = '';
            document.getElementById('modalNewPasswordConfirm').value = '';
            document.getElementById('modalChangePassMsg').classList.add('hidden');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePassModal').classList.add('hidden');
        }

        async function doChangePasswordModal() {
            const oldPass = document.getElementById('modalOldPassword').value;
            const newPass = document.getElementById('modalNewPassword').value;
            const newPass2 = document.getElementById('modalNewPasswordConfirm').value;
            const msgEl = document.getElementById('modalChangePassMsg');

            if (!oldPass || !newPass) { msgEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'; msgEl.className = 'mt-4 p-3 rounded-xl text-center text-sm font-medium bg-red-50 text-red-500'; msgEl.classList.remove('hidden'); return; }
            if (newPass !== newPass2) { msgEl.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô'; msgEl.className = 'mt-4 p-3 rounded-xl text-center text-sm font-medium bg-red-50 text-red-500'; msgEl.classList.remove('hidden'); return; }
            if (newPass.length < 6) { msgEl.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß'; msgEl.className = 'mt-4 p-3 rounded-xl text-center text-sm font-medium bg-red-50 text-red-500'; msgEl.classList.remove('hidden'); return; }
            try {
                const user = auth.currentUser;
                const cred = firebase.auth.EmailAuthProvider.credential(user.email, oldPass);
                await user.reauthenticateWithCredential(cred);
                await user.updatePassword(newPass);
                msgEl.textContent = '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üîê‚úÖ';
                msgEl.className = 'mt-4 p-3 rounded-xl text-center text-sm font-medium bg-green-50 text-green-600';
                msgEl.classList.remove('hidden');
                setTimeout(() => closeChangePasswordModal(), 2000);
            } catch (e) {
                msgEl.textContent = getErrorMessage(e.code);
                msgEl.className = 'mt-4 p-3 rounded-xl text-center text-sm font-medium bg-red-50 text-red-500';
                msgEl.classList.remove('hidden');
            }
        }

        function backToMembers() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('membersArea').classList.remove('hidden');
        }

        function getErrorMessage(code) {
            const msgs = {
                'auth/wrong-password': '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                'auth/user-not-found': '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ',
                'auth/email-already-in-use': '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
                'auth/invalid-email': '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                'auth/weak-password': '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß',
                'auth/too-many-requests': '‡∏•‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                'auth/popup-closed-by-user': '‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Google ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î',
                'auth/invalid-credential': '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
            };
            return msgs[code] || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + code;
        }

        // ==================== AUTH STATE OBSERVER ====================
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('membersArea').classList.remove('hidden');
                // Update UI
                document.getElementById('userDisplayName').textContent = user.displayName || user.email;
                document.getElementById('sidebarName').textContent = user.displayName || '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏°‡∏∞';
                document.getElementById('sidebarEmail').textContent = user.email;
                if (user.photoURL) {
                    document.getElementById('userAvatar').src = user.photoURL;
                    document.getElementById('userAvatar').classList.remove('hidden');
                    document.getElementById('sidebarAvatar').src = user.photoURL;
                }
                document.getElementById('profileName').value = user.displayName || '';
                document.getElementById('profileEmail').value = user.email;
                document.getElementById('profilePhoto').value = user.photoURL || '';
                loadNotes();
            } else {
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('membersArea').classList.add('hidden');
                showForm('login');
            }
        });

        // ==================== PROFILE ====================
        async function saveProfile() {
            const user = auth.currentUser;
            const name = document.getElementById('profileName').value.trim();
            const photo = document.getElementById('profilePhoto').value.trim();
            try {
                await user.updateProfile({ displayName: name, photoURL: photo || null });
                document.getElementById('userDisplayName').textContent = name;
                document.getElementById('sidebarName').textContent = name;
                if (photo) {
                    document.getElementById('userAvatar').src = photo;
                    document.getElementById('sidebarAvatar').src = photo;
                    document.getElementById('userAvatar').classList.remove('hidden');
                }
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üê±');
            } catch (e) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, true);
            }
        }

        // ==================== SECTIONS NAV ====================
        function showSection(section) {
            document.getElementById('sectionNotes').classList.add('hidden');
            document.getElementById('sectionProfile').classList.add('hidden');
            document.getElementById('section' + section.charAt(0).toUpperCase() + section.slice(1)).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
        }

        // ==================== NOTES SYSTEM ====================
        let notes = [];
        let currentNoteId = null;
        let quill = null;
        let currentAttachments = [];

        // Initialize Quill
        function initQuill() {
            if (quill) return;
            quill = new Quill('#quillEditor', {
                theme: 'snow',
                placeholder: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Note ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà... üìù',
                modules: {
                    toolbar: [
                        [{ header: [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ color: [] }, { background: [] }],
                        [{ list: 'ordered' }, { list: 'bullet' }],
                        ['blockquote', 'code-block'],
                        ['link', 'image', 'video'],
                        [{ align: [] }],
                        ['clean']
                    ]
                }
            });
        }

        async function loadNotes() {
            const user = auth.currentUser;
            if (!user) return;
            try {
                const snap = await db.collection('users').doc(user.uid).collection('notes')
                    .orderBy('updatedAt', 'desc').get();
                notes = [];
                snap.forEach(doc => notes.push({ id: doc.id, ...doc.data() }));
                renderNoteList();
            } catch (e) { console.error('Load notes error:', e); }
        }

        function renderNoteList() {
            const list = document.getElementById('noteList');
            if (notes.length === 0) {
                list.innerHTML = '<div class="text-center py-10 text-rose-200 col-span-full"><div class="text-5xl mb-2">üìã</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Note ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡πÄ‡∏•‡∏¢!</p></div>';
                return;
            }
            list.innerHTML = notes.map(n => `
                <div class="note-card ${currentNoteId === n.id ? 'active' : ''}" onclick="openNote('${n.id}')">
                    <h3 class="font-bold text-gray-700 mb-1 truncate">${escapeHtml(n.title || 'Untitled Note')}</h3>
                    <p class="text-xs text-gray-400 mb-2">${n.updatedAt ? new Date(n.updatedAt.seconds * 1000).toLocaleString('th-TH') : ''}</p>
                    <p class="text-sm text-gray-500 line-clamp-2">${(n.textPreview || '').substring(0, 80)}...</p>
                    <div class="flex justify-between items-center mt-2">
                        <div class="flex gap-1">
                            ${n.hasDrawing ? '<span class="text-xs bg-purple-100 text-purple-500 px-2 py-0.5 rounded-full">üé® ‡∏ß‡∏≤‡∏î</span>' : ''}
                            ${(n.attachments || []).length > 0 ? '<span class="text-xs bg-blue-100 text-blue-500 px-2 py-0.5 rounded-full">üìé ' + n.attachments.length + '</span>' : ''}
                        </div>
                        <button onclick="event.stopPropagation();deleteNote('${n.id}')" class="text-red-300 hover:text-red-500 text-xs">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function createNewNote() {
            initQuill();
            currentNoteId = null;
            currentAttachments = [];
            document.getElementById('noteTitle').value = '';
            quill.setContents([]);
            clearCanvas();
            document.getElementById('attachmentList').innerHTML = '';
            document.getElementById('noteEditor').classList.remove('hidden');
            switchEditorTab('write');
        }

        async function openNote(id) {
            initQuill();
            const note = notes.find(n => n.id === id);
            if (!note) return;
            currentNoteId = id;
            currentAttachments = note.attachments || [];
            document.getElementById('noteTitle').value = note.title || '';
            quill.setContents(note.content ? JSON.parse(note.content) : []);

            // Load drawing
            if (note.drawingData) {
                const canvas = document.getElementById('drawingCanvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); };
                img.src = note.drawingData;
            } else {
                clearCanvas();
            }

            renderAttachments();
            document.getElementById('noteEditor').classList.remove('hidden');
            switchEditorTab('write');
            renderNoteList();
        }

        async function saveCurrentNote() {
            const user = auth.currentUser;
            if (!user) return;
            const title = document.getElementById('noteTitle').value.trim() || 'Untitled Note';
            const content = JSON.stringify(quill.getContents());
            const textPreview = quill.getText().substring(0, 200);
            const canvas = document.getElementById('drawingCanvas');
            const drawingData = canvas.toDataURL();
            const hasDrawing = canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height).data.some((v, i) => i % 4 === 3 && v > 0);

            const noteData = {
                title, content, textPreview, drawingData: hasDrawing ? drawingData : null,
                hasDrawing, attachments: currentAttachments,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                const ref = db.collection('users').doc(user.uid).collection('notes');
                if (currentNoteId) {
                    await ref.doc(currentNoteId).update(noteData);
                } else {
                    noteData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    const docRef = await ref.add(noteData);
                    currentNoteId = docRef.id;
                }
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Note ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üíæüêæ');
                await loadNotes();
            } catch (e) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, true);
            }
        }

        async function deleteNote(id) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö Note ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?')) return;
            try {
                await db.collection('users').doc(auth.currentUser.uid).collection('notes').doc(id).delete();
                if (currentNoteId === id) closeEditor();
                showToast('‡∏•‡∏ö Note ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üóëÔ∏è');
                await loadNotes();
            } catch (e) { showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message, true); }
        }

        function closeEditor() {
            document.getElementById('noteEditor').classList.add('hidden');
            currentNoteId = null;
        }

        // ==================== EDITOR TABS ====================
        function switchEditorTab(tab) {
            ['Write', 'Draw', 'Attach'].forEach(t => {
                document.getElementById('editor' + t).classList.add('hidden');
                document.getElementById('tab' + t).classList.remove('active');
            });
            document.getElementById('editor' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');

            if (tab === 'draw') initCanvas();
        }

        // ==================== DRAWING CANVAS ====================
        let drawCtx, isDrawing = false, drawTool = 'pen', drawHistory = [], startX, startY;

        function initCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            if (!drawCtx) {
                drawCtx = canvas.getContext('2d');
                canvas.addEventListener('mousedown', startDraw);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', endDraw);
                canvas.addEventListener('mouseleave', endDraw);
                // Touch support
                canvas.addEventListener('touchstart', e => { e.preventDefault(); startDraw(getTouchPos(e)); });
                canvas.addEventListener('touchmove', e => { e.preventDefault(); draw(getTouchPos(e)); });
                canvas.addEventListener('touchend', e => { e.preventDefault(); endDraw(); });
            }
        }

        function getTouchPos(e) {
            const rect = e.target.getBoundingClientRect();
            const t = e.touches[0];
            return { offsetX: t.clientX - rect.left, offsetY: t.clientY - rect.top };
        }

        function startDraw(e) {
            isDrawing = true;
            startX = e.offsetX;
            startY = e.offsetY;
            if (drawTool === 'pen' || drawTool === 'eraser') {
                drawCtx.beginPath();
                drawCtx.moveTo(startX, startY);
            }
            if (drawTool === 'text') {
                const text = prompt('‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:');
                if (text) {
                    drawCtx.font = document.getElementById('drawSize').value * 4 + 'px Noto Sans Thai';
                    drawCtx.fillStyle = document.getElementById('drawColor').value;
                    drawCtx.fillText(text, startX, startY);
                    saveCanvasState();
                }
                isDrawing = false;
            }
        }

        function draw(e) {
            if (!isDrawing) return;
            const color = document.getElementById('drawColor').value;
            const size = parseInt(document.getElementById('drawSize').value);

            if (drawTool === 'pen') {
                drawCtx.strokeStyle = color;
                drawCtx.lineWidth = size;
                drawCtx.lineCap = 'round';
                drawCtx.lineJoin = 'round';
                drawCtx.lineTo(e.offsetX, e.offsetY);
                drawCtx.stroke();
            } else if (drawTool === 'eraser') {
                drawCtx.strokeStyle = 'white';
                drawCtx.lineWidth = size * 4;
                drawCtx.lineCap = 'round';
                drawCtx.lineTo(e.offsetX, e.offsetY);
                drawCtx.stroke();
            }
        }

        function endDraw(e) {
            if (!isDrawing) return;
            isDrawing = false;

            if (['rect', 'circle', 'arrow'].includes(drawTool) && e) {
                const color = document.getElementById('drawColor').value;
                const size = parseInt(document.getElementById('drawSize').value);
                drawCtx.strokeStyle = color;
                drawCtx.lineWidth = size;

                if (drawTool === 'rect') {
                    drawCtx.strokeRect(startX, startY, e.offsetX - startX, e.offsetY - startY);
                } else if (drawTool === 'circle') {
                    const rx = Math.abs(e.offsetX - startX) / 2;
                    const ry = Math.abs(e.offsetY - startY) / 2;
                    drawCtx.beginPath();
                    drawCtx.ellipse(startX + (e.offsetX - startX) / 2, startY + (e.offsetY - startY) / 2, rx, ry, 0, 0, 2 * Math.PI);
                    drawCtx.stroke();
                } else if (drawTool === 'arrow') {
                    drawCtx.beginPath();
                    drawCtx.moveTo(startX, startY);
                    drawCtx.lineTo(e.offsetX, e.offsetY);
                    drawCtx.stroke();
                    // Arrowhead
                    const angle = Math.atan2(e.offsetY - startY, e.offsetX - startX);
                    drawCtx.beginPath();
                    drawCtx.moveTo(e.offsetX, e.offsetY);
                    drawCtx.lineTo(e.offsetX - 15 * Math.cos(angle - 0.4), e.offsetY - 15 * Math.sin(angle - 0.4));
                    drawCtx.moveTo(e.offsetX, e.offsetY);
                    drawCtx.lineTo(e.offsetX - 15 * Math.cos(angle + 0.4), e.offsetY - 15 * Math.sin(angle + 0.4));
                    drawCtx.stroke();
                }
            }
            saveCanvasState();
        }

        function setDrawTool(tool) {
            drawTool = tool;
            document.querySelectorAll('#editorDraw .draw-tool').forEach(el => el.classList.remove('active'));
            document.getElementById('tool' + tool.charAt(0).toUpperCase() + tool.slice(1)).classList.add('active');
        }

        function clearCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawHistory = [];
            }
        }

        function saveCanvasState() {
            const canvas = document.getElementById('drawingCanvas');
            drawHistory.push(canvas.toDataURL());
            if (drawHistory.length > 30) drawHistory.shift();
        }

        function undoCanvas() {
            if (drawHistory.length < 2) { clearCanvas(); return; }
            drawHistory.pop();
            const img = new Image();
            img.onload = () => {
                const canvas = document.getElementById('drawingCanvas');
                drawCtx.clearRect(0, 0, canvas.width, canvas.height);
                drawCtx.drawImage(img, 0, 0);
            };
            img.src = drawHistory[drawHistory.length - 1];
        }

        // ==================== FILE ATTACHMENTS ====================
        async function handleFileUpload(input) {
            const user = auth.currentUser;
            if (!user) return;
            const files = Array.from(input.files);

            for (const file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    showToast('‡πÑ‡∏ü‡∏•‡πå ' + file.name + ' ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10MB', true);
                    continue;
                }
                try {
                    showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ' + file.name + '...');
                    const ref = storage.ref(`users/${user.uid}/notes/${Date.now()}_${file.name}`);
                    await ref.put(file);
                    const url = await ref.getDownloadURL();
                    currentAttachments.push({
                        name: file.name,
                        url: url,
                        type: file.type,
                        size: file.size
                    });
                    renderAttachments();
                    showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ' + file.name + ' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìé');
                } catch (e) {
                    showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + e.message, true);
                }
            }
            input.value = '';
        }

        function renderAttachments() {
            const list = document.getElementById('attachmentList');
            if (currentAttachments.length === 0) { list.innerHTML = ''; return; }
            list.innerHTML = currentAttachments.map((a, i) => {
                let preview = '';
                if (a.type && a.type.startsWith('image/')) {
                    preview = `<img src="${a.url}" class="w-full h-32 object-cover rounded-lg mb-2" alt="${escapeHtml(a.name)}">`;
                } else if (a.type && a.type.startsWith('video/')) {
                    preview = `<video src="${a.url}" controls class="w-full h-32 rounded-lg mb-2"></video>`;
                }
                return `
                    <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
                        ${preview}
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm font-medium text-gray-700">${escapeHtml(a.name)}</p>
                                <p class="text-xs text-gray-400">${(a.size / 1024).toFixed(1)} KB</p>
                            </div>
                            <div class="flex gap-2">
                                <a href="${a.url}" target="_blank" class="text-blue-500 text-xs hover:underline">‡πÄ‡∏õ‡∏¥‡∏î</a>
                                <button onclick="removeAttachment(${i})" class="text-red-400 text-xs hover:text-red-600">‡∏•‡∏ö</button>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        function removeAttachment(idx) {
            currentAttachments.splice(idx, 1);
            renderAttachments();
        }

        // ==================== UTILS ====================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function showToast(msg, isError = false) {
            const t = document.createElement('div');
            t.className = 'toast-msg';
            if (isError) t.style.background = '#ef4444';
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>

</html>