<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó‡∏ô‡πâ‡∏≠‡∏á‡∏Ñ‡∏∏‡∏°‡∏∞ üê±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Quill.js Rich Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
    <style>
        * {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 30%, #fff1f2 60%, #fef9c3 100%);
            min-height: 100vh;
        }

        /* Auth Card */
        .auth-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 2px solid #fecdd3;
            border-radius: 2rem;
            box-shadow: 0 20px 60px rgba(253, 164, 175, 0.15);
        }

        .auth-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #fecdd3;
            border-radius: 1rem;
            outline: none;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: #fff5f5;
        }

        .auth-input:focus {
            border-color: #fb7185;
            box-shadow: 0 0 0 3px rgba(251, 113, 133, 0.15);
            background: white;
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            border-radius: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 1rem;
        }

        .auth-btn-primary {
            background: linear-gradient(135deg, #fb7185, #f43f5e);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 63, 94, 0.3);
        }

        .auth-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 63, 94, 0.4);
        }

        .auth-btn-google {
            background: white;
            color: #374151;
            border: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .auth-btn-google:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .auth-link {
            color: #f43f5e;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        /* Members Area */
        .member-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border: 2px solid #fecdd3;
            border-radius: 1.5rem;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        .member-card:hover {
            box-shadow: 0 8px 30px rgba(253, 164, 175, 0.2);
            transform: translateY(-2px);
        }

        /* Note Cards */
        .note-card {
            background: white;
            border: 2px solid #fed7aa;
            border-radius: 1rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .note-card:hover {
            border-color: #fb923c;
            box-shadow: 0 4px 15px rgba(251, 146, 60, 0.15);
            transform: translateY(-2px);
        }

        .note-card.active {
            border-color: #f43f5e;
            background: #fff1f2;
        }

        /* Quill Editor Override */
        .ql-container {
            border-radius: 0 0 1rem 1rem;
            border-color: #fecdd3 !important;
            min-height: 250px;
            font-family: 'Noto Sans Thai', sans-serif;
        }

        .ql-toolbar {
            border-radius: 1rem 1rem 0 0;
            border-color: #fecdd3 !important;
            background: #fff5f5;
        }

        .ql-editor {
            min-height: 250px;
        }

        /* Drawing Canvas */
        #drawingCanvas {
            border: 2px dashed #fecdd3;
            border-radius: 1rem;
            cursor: crosshair;
            background: white;
        }

        /* Sidebar nav */
        .nav-item {
            padding: 10px 16px;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-item:hover {
            background: #ffe4e6;
        }

        .nav-item.active {
            background: #fda4af;
            color: white;
        }

        /* Toast */
        .toast-msg {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 1rem;
            font-weight: 600;
            z-index: 9999;
            animation: slideUp 0.3s ease, fadeOut 0.3s 2.5s ease forwards;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.15);
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Drawing toolbar */
        .draw-tool {
            padding: 6px 12px;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            background: white;
        }

        .draw-tool:hover {
            border-color: #fb7185;
        }

        .draw-tool.active {
            background: #fb7185;
            color: white;
            border-color: #fb7185;
        }

        .hidden {
            display: none !important;
        }

        /* ==================== MOBILE RESPONSIVE ==================== */
        @media (max-width: 1023px) {
            .right-sidebar {
                display: none !important;
            }
        }

        @media (max-width: 767px) {
            .members-layout {
                flex-direction: column;
                padding: 0.75rem !important;
                gap: 0.75rem !important;
            }

            .left-sidebar {
                position: fixed;
                top: 0;
                left: -280px;
                width: 260px;
                height: 100vh;
                z-index: 900;
                transition: left 0.3s ease;
                padding-top: 70px;
                overflow-y: auto;
                background: linear-gradient(135deg, #fdf2f8, #fff1f2);
            }

            .left-sidebar.open {
                left: 0;
            }

            .left-sidebar .member-card {
                border-radius: 0;
                border: none;
                border-right: 2px solid #fecdd3;
            }

            .sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.3);
                z-index: 899;
                display: none;
            }

            .sidebar-overlay.show {
                display: block;
            }

            .main-content {
                min-width: 0 !important;
            }

            .member-card {
                padding: 0.75rem;
                border-radius: 0.75rem;
            }

            /* Top header mobile */
            .top-header {
                padding: 0.5rem 0.75rem !important;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .top-header .header-left {
                gap: 0.25rem !important;
            }

            .top-header .header-left .back-link {
                display: none;
            }

            .top-header .header-left .header-sep {
                display: none;
            }

            .top-header .header-title {
                font-size: 0.85rem !important;
            }

            .top-header .header-right {
                gap: 0.25rem !important;
            }

            .top-header .header-right .user-name {
                display: none;
            }

            .top-header .logout-btn {
                padding: 6px 10px !important;
                font-size: 0.7rem !important;
            }

            /* Chat section mobile */
            .chat-layout {
                flex-direction: column !important;
                height: auto !important;
            }

            .chat-sidebar {
                width: 100% !important;
                max-height: 200px;
            }

            .chat-window {
                min-height: 350px;
            }

            /* Grids single column */
            .grid {
                grid-template-columns: 1fr !important;
            }

            h2 {
                font-size: 1.3rem !important;
            }
        }

        /* ==================== NOTIFICATION BADGES ==================== */
        .nav-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            border-radius: 9px;
            background: #f43f5e;
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            margin-left: auto;
            animation: badgePop 0.3s ease;
        }

        .friend-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 16px;
            height: 16px;
            padding: 0 4px;
            border-radius: 8px;
            background: #f43f5e;
            color: white;
            font-size: 0.6rem;
            font-weight: 700;
            margin-left: 4px;
        }

        @keyframes badgePop {
            from {
                transform: scale(0);
            }

            to {
                transform: scale(1);
            }
        }

        /* ==================== EMOJI PICKER ==================== */
        .emoji-picker-panel {
            position: absolute;
            bottom: 100%;
            right: 0;
            width: 280px;
            max-height: 200px;
            background: white;
            border: 2px solid #fecdd3;
            border-radius: 1rem;
            padding: 0.5rem;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 -4px 20px rgba(253, 164, 175, 0.2);
            display: none;
        }

        .emoji-picker-panel.show {
            display: block;
        }

        .emoji-picker-panel span {
            cursor: pointer;
            font-size: 1.3rem;
            padding: 3px;
            display: inline-block;
            transition: transform 0.1s;
        }

        .emoji-picker-panel span:hover {
            transform: scale(1.3);
        }

        /* Chat image preview */
        .chat-img-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 0.75rem;
            margin-top: 4px;
            cursor: pointer;
        }

        .post-img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 1rem;
            margin-top: 0.5rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .post-img:hover {
            opacity: 0.85;
        }

        /* Image Lightbox */
        .lightbox-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            animation: modalIn 0.2s ease;
        }

        .lightbox-overlay img {
            max-width: 92vw;
            max-height: 90vh;
            border-radius: 1rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            object-fit: contain;
        }

        .lightbox-close {
            position: fixed;
            top: 16px;
            right: 20px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        /* Chat notification toast */
        .chat-notif-toast { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #fb7185, #f43f5e); color: white; padding: 12px 20px; border-radius: 1rem; box-shadow: 0 8px 30px rgba(244,63,94,0.4); z-index: 9999; cursor: pointer; animation: slideInRight 0.3s ease; max-width: 320px; font-size: 0.85rem; }
        .chat-notif-toast strong { font-size: 0.9rem; }
        .chat-notif-toast span { opacity: 0.9; font-size: 0.8rem; }
        @keyframes slideInRight { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }


        /* Chat notification toast */
        .chat-notif-toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #fff0f3, #ffe4e8);
            border: 2px solid #fda4af;
            color: #881337;
            padding: 16px 22px;
            border-radius: 1.2rem;
            box-shadow: 0 10px 40px rgba(244,63,94,0.25), 0 0 0 1px rgba(244,63,94,0.1);
            z-index: 9998;
            cursor: pointer;
            animation: toastSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 360px;
            min-width: 240px;
            backdrop-filter: blur(10px);
        }
        .chat-notif-toast .toast-icon { font-size: 1.8rem; margin-right: 10px; }
        .chat-notif-toast .toast-title { font-size: 1rem; font-weight: 700; color: #e11d48; margin-bottom: 3px; }
        .chat-notif-toast .toast-body { font-size: 0.9rem; color: #6b2140; opacity: 0.85; }
        .chat-notif-toast .toast-close { position: absolute; top: 8px; right: 12px; color: #fda4af; font-size: 1rem; cursor: pointer; background: none; border: none; }
        .chat-notif-toast .toast-close:hover { color: #e11d48; }
        @keyframes toastSlideIn {
            from { transform: translateX(120%) scale(0.8); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }
        @keyframes toastSlideOut {
            from { transform: translateX(0) scale(1); opacity: 1; }
            to { transform: translateX(120%) scale(0.8); opacity: 0; }
        }
        /* ==================== KUMA AI FLOATING CHAT ==================== */
        .kuma-fab {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 52px;
            height: 58px;
            border-radius: 0 1rem 1rem 0;
            background: linear-gradient(180deg, #fff0f3, #fecdd3);
            border: 2px solid #fda4af;
            border-left: none;
            cursor: pointer;
            z-index: 800;
            box-shadow: 4px 4px 20px rgba(244, 63, 94, 0.25);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: #f43f5e;
        }

        .kuma-fab:hover {
            width: 60px;
            box-shadow: 6px 6px 30px rgba(244, 63, 94, 0.4);
            background: linear-gradient(180deg, #ffe4e8, #fda4af);
        }

        .kuma-chat-panel {
            position: fixed;
            bottom: 60px;
            left: 60px;
            width: 380px;
            max-height: 500px;
            background: white;
            border-radius: 1.5rem;
            border: 2px solid #fecdd3;
            box-shadow: 0 15px 50px rgba(253, 164, 175, 0.3);
            z-index: 801;
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: modalIn 0.3s ease;
        }

        .kuma-chat-panel.open {
            display: flex;
        }

        @media (max-width: 500px) {
            .kuma-chat-panel {
                width: calc(100vw - 24px);
                left: 12px;
                bottom: 70px;
                max-height: 60vh;
            }

            .kuma-fab {
                width: 46px;
                height: 50px;
                font-size: 1.4rem;
                top: 50%;
                left: 0;
            }
        }

        .kuma-chat-bubble {
            border-radius: 1.2rem;
            padding: 0.6rem 0.9rem;
            max-width: 85%;
            font-size: 0.85rem;
            line-height: 1.4;
            margin-bottom: 0.4rem;
        }

        .kuma-chat-bubble.user {
            background: #fda4af;
            color: white;
            border-bottom-right-radius: 0.25rem;
            margin-left: auto;
        }

        .kuma-chat-bubble.ai {
            background: #fff5f5;
            color: #4b5563;
            border: 1.5px solid #fecdd3;
            border-bottom-left-radius: 0.25rem;
            margin-right: auto;
        }

        .kuma-typing-dot {
            width: 5px;
            height: 5px;
            background: #fda4af;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1s infinite alternate;
        }

        @keyframes typing {
            from {
                opacity: 0.3;
                transform: translateY(0)
            }

            to {
                opacity: 1;
                transform: translateY(-3px)
            }
        }
    </style>
</head>

<body>
    <!-- ==================== AUTH SCREEN ==================== -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="auth-card p-8 max-w-md w-full">
            <!-- Login Form -->
            <div id="loginForm">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">üê±üîê</div>
                    <h1 class="text-2xl font-bold text-rose-500">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó‡∏ô‡πâ‡∏≠‡∏á‡∏Ñ‡∏∏‡∏°‡∏∞</h1>
                    <p class="text-rose-300 text-sm mt-1">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©!</p>
                </div>
                <div class="space-y-4">
                    <input type="email" id="loginEmail" class="auth-input" placeholder="üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                    <input type="password" id="loginPassword" class="auth-input" placeholder="üîí ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                    <button onclick="doLogin()" class="auth-btn auth-btn-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡πÄ‡∏°‡∏µ‡πâ‡∏¢‡∏ß üêæ</button>
                    <div class="flex items-center gap-3 my-2">
                        <div class="flex-1 h-px bg-rose-200"></div>
                        <span class="text-rose-300 text-xs">‡∏´‡∏£‡∏∑‡∏≠</span>
                        <div class="flex-1 h-px bg-rose-200"></div>
                    </div>
                    <button onclick="doGoogleLogin()" class="auth-btn auth-btn-google">
                        <svg width="20" height="20" viewBox="0 0 48 48">
                            <path fill="#EA4335"
                                d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z" />
                            <path fill="#4285F4"
                                d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z" />
                            <path fill="#FBBC05"
                                d="M10.53 28.59a14.5 14.5 0 010-9.18l-7.98-6.19a24.01 24.01 0 000 21.56l7.98-6.19z" />
                            <path fill="#34A853"
                                d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z" />
                        </svg>
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
                    </button>
                </div>
                <div class="flex justify-between mt-6">
                    <span class="auth-link" onclick="showForm('register')">üìù ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
                    <span class="auth-link" onclick="showForm('forgot')">üîë ‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</span>
                </div>
                <div class="text-center mt-4">
                    <a href="/" class="text-rose-300 text-sm hover:text-rose-500 transition-colors">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
                </div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">üê±‚ú®</div>
                    <h1 class="text-2xl font-bold text-rose-500">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏°‡∏∞!</h1>
                    <p class="text-rose-300 text-sm mt-1">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏µ‡∏°</p>
                </div>
                <div class="space-y-4">
                    <input type="text" id="regDisplayName" class="auth-input"
                        placeholder="üò∏ ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á (Display Name)">
                    <input type="email" id="regEmail" class="auth-input" placeholder="üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                    <input type="password" id="regPassword" class="auth-input"
                        placeholder="üîí ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß)">
                    <input type="password" id="regPasswordConfirm" class="auth-input" placeholder="üîí ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                    <button onclick="doRegister()" class="auth-btn auth-btn-primary">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡πÄ‡∏°‡∏µ‡πâ‡∏¢‡∏ß üêæ</button>
                </div>
                <div class="text-center mt-4">
                    <span class="auth-link" onclick="showForm('login')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login</span>
                </div>
            </div>

            <!-- Forgot Password Form -->
            <div id="forgotForm" class="hidden">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">üîëüòø</div>
                    <h1 class="text-2xl font-bold text-rose-500">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h1>
                    <p class="text-rose-300 text-sm mt-1">‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</p>
                </div>
                <div class="space-y-4">
                    <input type="email" id="forgotEmail" class="auth-input" placeholder="üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£">
                    <button onclick="doForgotPassword()" class="auth-btn auth-btn-primary">‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï üìß</button>
                </div>
                <div class="text-center mt-4">
                    <span class="auth-link" onclick="showForm('login')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login</span>
                </div>
            </div>

            <!-- Change Password Form -->
            <div id="changePassForm" class="hidden">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">üîêüîÑ</div>
                    <h1 class="text-2xl font-bold text-rose-500">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h1>
                </div>
                <div class="space-y-4">
                    <input type="password" id="oldPassword" class="auth-input" placeholder="üîí ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°">
                    <input type="password" id="newPassword" class="auth-input" placeholder="üîë ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                    <input type="password" id="newPasswordConfirm" class="auth-input"
                        placeholder="üîë ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                    <button onclick="doChangePassword()" class="auth-btn auth-btn-primary">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô üîÑ</button>
                </div>
                <div class="text-center mt-4">
                    <span class="auth-link" onclick="showForm('login')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login</span>
                    <span id="backToMembersLink" class="auth-link hidden ml-4" onclick="backToMembers()">‚Üê
                        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
                </div>
            </div>

            <!-- Error/Success Message -->
            <div id="authMessage" class="hidden mt-4 p-3 rounded-xl text-center text-sm font-medium"></div>
        </div>
    </div>

    <!-- ==================== MEMBERS AREA (Hidden until login) ==================== -->
    <div id="membersArea" class="hidden min-h-screen">
        <!-- Top Bar -->
        <div
            class="bg-white/80 backdrop-blur-lg border-b-2 border-rose-200 px-6 py-3 flex justify-between items-center sticky top-0 z-50 top-header">
            <div class="flex items-center gap-3 header-left">
                <button id="hamburgerBtn" class="md:hidden text-rose-400 text-2xl p-1"
                    onclick="toggleMobileSidebar()">‚ò∞</button>
                <a href="/" class="text-rose-400 hover:text-rose-600 text-sm font-medium back-link">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
                <span class="text-rose-200 header-sep">|</span>
                <span class="text-lg">üê±</span>
                <span class="font-bold text-rose-500 header-title">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó‡∏ô‡πâ‡∏≠‡∏á‡∏Ñ‡∏∏‡∏°‡∏∞</span>
            </div>
            <div class="flex items-center gap-3 header-right">
                <span id="userDisplayName" class="text-sm text-gray-600 font-medium user-name"></span>
                <img id="userAvatar" src="" class="w-8 h-8 rounded-full border-2 border-rose-300 hidden" alt="avatar">
                <button onclick="doLogout()"
                    class="bg-rose-100 text-rose-500 px-4 py-2 rounded-xl text-sm font-bold hover:bg-rose-200 transition-colors logout-btn">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö üö™
                </button>
            </div>
        </div>

        <div class="max-w-7xl mx-auto p-6 sm:p-4 flex gap-6 members-layout"><!-- mobile hamburger -->
            <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>
            <!-- Left Sidebar Nav -->
            <div class="w-56 shrink-0 left-sidebar" id="leftSidebar">
                <div class="member-card sticky top-20">
                    <div class="text-center mb-4">
                        <img id="sidebarAvatar"
                            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23fda4af'/%3E%3Ctext x='50' y='60' text-anchor='middle' font-size='40'%3Eüê±%3C/text%3E%3C/svg%3E"
                            class="w-16 h-16 rounded-full mx-auto border-3 border-rose-300 mb-2" alt="">
                        <p id="sidebarName" class="font-bold text-rose-500 text-sm"></p>
                        <p id="sidebarEmail" class="text-xs text-gray-400"></p>
                    </div>
                    <hr class="border-rose-100 mb-3">
                    <div class="space-y-1">
                        <div class="nav-item active" onclick="showSection('notes')">üìù Notes</div>
                        <div class="nav-item" id="navChat" onclick="showSection('chat')">üí¨ ‡πÅ‡∏ä‡∏ó <span id="badgeChat"
                                class="nav-badge hidden">0</span></div>
                        <div class="nav-item" id="navFriends" onclick="showSection('friends')">üë• ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô <span
                                id="badgeFriends" class="nav-badge hidden">0</span></div>
                        <div class="nav-item" id="navPosts" onclick="showSection('posts')">üì¢ ‡πÇ‡∏û‡∏™‡∏ï‡πå <span
                                id="badgePosts" class="nav-badge hidden">0</span></div>
                        <hr class="border-rose-100 my-2">
                        <div class="nav-item" onclick="showSection('profile')">‚öôÔ∏è ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</div>
                        <div class="nav-item" onclick="showChangePasswordModal()">
                            üîê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™</div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="flex-1 main-content">
                <!-- Notes Section -->
                <div id="sectionNotes">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-rose-500">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Notes ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                        <button onclick="createNewNote()"
                            class="bg-gradient-to-r from-rose-400 to-orange-400 text-white px-5 py-2 rounded-xl font-bold text-sm hover:shadow-lg transition-all hover:-translate-y-0.5">
                            ‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á Note ‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>

                    <!-- Note List -->
                    <div id="noteList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <div class="text-center py-10 text-rose-200 col-span-full">
                            <div class="text-5xl mb-2">üìã</div>
                            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Note ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡πÄ‡∏•‡∏¢!</p>
                        </div>
                    </div>

                    <!-- Note Editor (hidden by default) -->
                    <div id="noteEditor" class="hidden member-card">
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" id="noteTitle" placeholder="‚úèÔ∏è ‡∏ä‡∏∑‡πà‡∏≠ Note..."
                                class="text-xl font-bold text-rose-500 bg-transparent border-none outline-none flex-1"
                                value="">
                            <div class="flex gap-2">
                                <button onclick="saveCurrentNote()"
                                    class="bg-green-100 text-green-600 px-4 py-2 rounded-xl text-sm font-bold hover:bg-green-200 transition-colors">üíæ
                                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                <button onclick="closeEditor()"
                                    class="bg-gray-100 text-gray-500 px-4 py-2 rounded-xl text-sm font-bold hover:bg-gray-200 transition-colors">‚úï
                                    ‡∏õ‡∏¥‡∏î</button>
                            </div>
                        </div>

                        <!-- Editor Tabs -->
                        <div class="flex gap-2 mb-4">
                            <button onclick="switchEditorTab('write')" id="tabWrite" class="draw-tool active">üìù
                                ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</button>
                            <button onclick="switchEditorTab('draw')" id="tabDraw" class="draw-tool">üé® ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ</button>
                            <button onclick="switchEditorTab('attach')" id="tabAttach" class="draw-tool">üìé
                                ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå</button>
                        </div>

                        <!-- Write Tab -->
                        <div id="editorWrite">
                            <div id="quillEditor"></div>
                        </div>

                        <!-- Draw Tab -->
                        <div id="editorDraw" class="hidden">
                            <div class="flex gap-2 mb-3 flex-wrap">
                                <button onclick="setDrawTool('pen')" class="draw-tool active" id="toolPen">‚úèÔ∏è
                                    ‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤</button>
                                <button onclick="setDrawTool('eraser')" class="draw-tool" id="toolEraser">üßπ ‡∏•‡∏ö</button>
                                <button onclick="setDrawTool('rect')" class="draw-tool" id="toolRect">‚¨ú
                                    ‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°</button>
                                <button onclick="setDrawTool('circle')" class="draw-tool" id="toolCircle">‚≠ï
                                    ‡∏ß‡∏á‡∏Å‡∏•‡∏°</button>
                                <button onclick="setDrawTool('arrow')" class="draw-tool" id="toolArrow">‚û°Ô∏è
                                    ‡∏•‡∏π‡∏Å‡∏®‡∏£</button>
                                <button onclick="setDrawTool('text')" class="draw-tool" id="toolText">üî§
                                    ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
                                <input type="color" id="drawColor" value="#f43f5e"
                                    class="w-8 h-8 rounded cursor-pointer border-2 border-gray-200">
                                <select id="drawSize" class="border-2 border-gray-200 rounded px-2 text-sm">
                                    <option value="2">‡πÄ‡∏™‡πâ‡∏ô‡∏ö‡∏≤‡∏á</option>
                                    <option value="4" selected>‡∏õ‡∏Å‡∏ï‡∏¥</option>
                                    <option value="8">‡∏´‡∏ô‡∏≤</option>
                                    <option value="12">‡∏´‡∏ô‡∏≤‡∏°‡∏≤‡∏Å</option>
                                </select>
                                <button onclick="clearCanvas()" class="draw-tool">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á</button>
                                <button onclick="undoCanvas()" class="draw-tool">‚Ü©Ô∏è Undo</button>
                            </div>
                            <canvas id="drawingCanvas" width="800" height="500"></canvas>
                        </div>

                        <!-- Attach Tab -->
                        <div id="editorAttach" class="hidden">
                            <div class="border-2 border-dashed border-rose-200 rounded-xl p-8 text-center cursor-pointer hover:border-rose-400 transition-colors"
                                onclick="document.getElementById('fileUploadInput').click()">
                                <div class="text-4xl mb-2">üìÇ</div>
                                <p class="text-rose-400 font-medium">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</p>
                                <p class="text-rose-300 text-xs mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡πÑ‡∏ü‡∏•‡πå, ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û, ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10MB)</p>
                                <input type="file" id="fileUploadInput" class="hidden" multiple
                                    accept="image/*,video/*,.pdf,.doc,.docx,.txt" onchange="handleFileUpload(this)">
                            </div>
                            <div id="attachmentList" class="mt-4 space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="sectionProfile" class="hidden">
                    <h2 class="text-2xl font-bold text-rose-500 mb-6">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h2>
                    <div class="member-card max-w-lg">
                        <div class="space-y-4">
                            <!-- Profile Photo Upload -->
                            <div>
                                <label class="block text-sm font-medium text-rose-500 mb-2">‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
                                <div class="flex items-start gap-4">
                                    <img id="profilePreview"
                                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23fda4af'/%3E%3Ctext x='50' y='60' text-anchor='middle' font-size='40'%3Eüê±%3C/text%3E%3C/svg%3E"
                                        class="w-20 h-20 rounded-full border-4 border-rose-300 object-cover shrink-0"
                                        alt="">
                                    <div class="flex-1">
                                        <div id="photoDropZone"
                                            class="border-2 border-dashed border-rose-200 rounded-xl p-4 text-center cursor-pointer hover:border-rose-400 hover:bg-rose-50/50 transition-all"
                                            onclick="document.getElementById('profilePhotoInput').click()">
                                            <div class="text-2xl mb-1">üì∑</div>
                                            <p class="text-rose-400 text-xs font-medium">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ / ‡∏•‡∏≤‡∏Å‡∏ß‡∏≤‡∏á / ‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ
                                            </p>
                                            <p class="text-rose-300 text-xs mt-0.5">Ctrl+V ‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å clipboard ‡πÑ‡∏î‡πâ</p>
                                        </div>
                                        <input type="file" id="profilePhotoInput" class="hidden" accept="image/*"
                                            onchange="handleProfilePhoto(this.files[0])">
                                        <div id="photoUploadStatus" class="text-xs mt-2 hidden"></div>
                                        <button id="removePhotoBtn"
                                            class="hidden text-xs text-red-400 hover:text-red-600 mt-1"
                                            onclick="removeProfilePhoto()">üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-rose-500 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</label>
                                <input type="text" id="profileName" class="auth-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-rose-500 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                                <input type="email" id="profileEmail" class="auth-input" disabled style="opacity:0.6">
                            </div>
                            <input type="hidden" id="profilePhoto" value="">
                            <button onclick="saveProfile()" class="auth-btn auth-btn-primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
                        </div>
                    </div>
                </div>

                <!-- ==================== CHAT SECTION ==================== -->
                <div id="sectionChat" class="hidden">
                    <h2 class="text-2xl font-bold text-rose-500 mb-4">üí¨ ‡πÅ‡∏ä‡∏ó <button id="soundToggleBtn" onclick="toggleNotifSound()" class="text-xs bg-rose-100 text-rose-400 px-2 py-0.5 rounded-full ml-2 hover:bg-rose-200 transition-all" title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á">üîî ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡∏¥‡∏î</button></h2>
                    <div class="flex gap-4 chat-layout" style="height:550px">
                        <!-- Chat List -->
                        <div class="w-64 shrink-0 member-card overflow-hidden flex flex-col chat-sidebar">
                            <div class="flex gap-2 mb-3">
                                <button onclick="showChatTab('private')" id="chatTabPrivate"
                                    class="flex-1 text-xs font-bold py-2 rounded-lg bg-rose-500 text-white">üí¨
                                    ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</button>
                                <button onclick="showChatTab('group')" id="chatTabGroup"
                                    class="flex-1 text-xs font-bold py-2 rounded-lg bg-gray-100 text-gray-500">üë•
                                    ‡∏Å‡∏£‡∏∏‡πä‡∏õ</button>
                            </div>
                            <button onclick="showNewGroupModal()"
                                class="w-full text-xs font-bold py-2 rounded-lg bg-orange-100 text-orange-500 mb-3 hover:bg-orange-200">‚ûï
                                ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∏‡πä‡∏õ‡πÉ‡∏´‡∏°‡πà</button>
                            <div id="chatList" class="flex-1 overflow-y-auto space-y-1"></div>
                        </div>
                        <!-- Chat Window -->
                        <div class="flex-1 member-card flex flex-col overflow-hidden chat-window">
                            <div id="chatHeader" class="flex items-center gap-3 pb-3 border-b border-rose-100 mb-3">
                                <span class="text-gray-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ä‡∏ó‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢</span>
                            </div>
                            <div id="chatMessages" class="flex-1 overflow-y-auto space-y-3 mb-3 pr-2"
                                style="scroll-behavior:smooth"></div>
                            <div id="chatImgPreview" class="hidden flex gap-2 mb-2 flex-wrap"></div>
                            <div id="chatInputArea" class="hidden relative">
                                <div id="chatEmojiPicker" class="emoji-picker-panel"></div>
                                <div class="flex gap-2 items-end">
                                    <button onclick="toggleChatEmoji()"
                                        class="text-xl p-1 hover:scale-110 transition-transform"
                                        title="‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥">üòä</button>
                                    <button onclick="document.getElementById('chatImgInput').click()"
                                        class="text-xl p-1 hover:scale-110 transition-transform"
                                        title="‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ">üñºÔ∏è</button>
                                    <input type="file" id="chatImgInput" class="hidden" accept="image/*"
                                        onchange="handleChatImage(this)">
                                    <input type="text" id="chatInput" class="auth-input flex-1"
                                        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." onkeydown="if(event.key==='Enter')sendMessage()">
                                    <button onclick="sendMessage()"
                                        class="bg-rose-500 text-white px-4 py-2 rounded-xl font-bold text-sm hover:bg-rose-600 shrink-0">‡∏™‡πà‡∏á
                                        üêæ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== FRIENDS SECTION ==================== -->
                <div id="sectionFriends" class="hidden">
                    <h2 class="text-2xl font-bold text-rose-500 mb-4">üë• ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</h2>
                    <div class="flex gap-2 mb-4">
                        <input type="email" id="addFriendEmail" class="auth-input flex-1"
                            placeholder="üìß ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°...">
                        <button onclick="sendFriendRequest()"
                            class="bg-rose-500 text-white px-5 py-2 rounded-xl font-bold text-sm hover:bg-rose-600 shrink-0">‚ûï
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</button>
                    </div>
                    <!-- Pending Requests -->
                    <div id="pendingRequests" class="mb-6 hidden">
                        <h3 class="text-sm font-bold text-amber-500 mb-2">üì® ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</h3>
                        <div id="pendingList" class="space-y-2"></div>
                    </div>
                    <!-- Friend List -->
                    <h3 class="text-sm font-bold text-rose-400 mb-2">üêæ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</h3>
                    <div id="friendList" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6"></div>

                    <!-- All Users Board -->
                    <h3 class="text-sm font-bold text-purple-500 mb-2">üåê ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
                    <div id="allUsersList" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                </div>

                <!-- ==================== POSTS SECTION ==================== -->
                <div id="sectionPosts" class="hidden">
                    <h2 class="text-2xl font-bold text-rose-500 mb-4">üì¢ ‡πÇ‡∏û‡∏™‡∏ï‡πå</h2>
                    <!-- New Post -->
                    <div class="member-card mb-6">
                        <textarea id="newPostText" class="w-full auth-input" rows="3"
                            placeholder="‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà? ‡πÄ‡∏°‡∏µ‡πâ‡∏¢‡∏ß üê±"></textarea>
                        <div id="postImgPreview" class="hidden mt-2"></div>
                        <div class="flex justify-between items-center mt-2">
                            <div class="flex gap-2">
                                <button onclick="togglePostEmoji()"
                                    class="text-xl p-1 hover:scale-110 transition-transform" title="‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥">üòä</button>
                                <button onclick="document.getElementById('postImgInput').click()"
                                    class="text-xl p-1 hover:scale-110 transition-transform" title="‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ">üñºÔ∏è</button>
                                <input type="file" id="postImgInput" class="hidden" accept="image/*"
                                    onchange="handlePostImage(this)">
                            </div>
                            <button onclick="createPost()"
                                class="bg-gradient-to-r from-rose-400 to-orange-400 text-white px-5 py-2 rounded-xl font-bold text-sm hover:shadow-lg">üì¢
                                ‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
                        </div>
                    </div>
                    <!-- Post Emoji Picker (outside overflow containers) -->
                    <div id="postEmojiPicker" class="emoji-picker-panel"
                        style="position:fixed; bottom:auto; top:auto; z-index:9000"></div>
                    <!-- Posts Feed -->
                    <div id="postsFeed" class="space-y-4"></div>
                </div>
            </div>

            <!-- ==================== RIGHT SIDEBAR: Online Members ==================== -->
            <div class="w-52 shrink-0 hidden lg:block right-sidebar">
                <div class="member-card sticky top-20">
                    <h3 class="text-sm font-bold text-rose-500 mb-3">üü¢ ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h3>
                    <div id="onlineList" class="space-y-2 max-h-80 overflow-y-auto"></div>
                    <hr class="border-rose-100 my-3">
                    <h3 class="text-sm font-bold text-gray-400 mb-3">‚ö´ ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå</h3>
                    <div id="offlineList" class="space-y-2 max-h-40 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal (overlay on members area) -->
    <div id="changePassModal" class="hidden modal-overlay">
        <div class="modal-content max-w-md">
            <div class="text-center mb-6">
                <div class="text-5xl mb-2">üîêüîÑ</div>
                <h1 class="text-2xl font-bold text-rose-500">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h1>
            </div>
            <div class="space-y-4">
                <input type="password" id="modalOldPassword" class="auth-input" placeholder="üîí ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°">
                <input type="password" id="modalNewPassword" class="auth-input" placeholder="üîë ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                <input type="password" id="modalNewPasswordConfirm" class="auth-input"
                    placeholder="üîë ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                <button onclick="doChangePasswordModal()" class="auth-btn auth-btn-primary">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô üîÑ</button>
            </div>
            <div id="modalChangePassMsg" class="hidden mt-4 p-3 rounded-xl text-center text-sm font-medium"></div>
            <div class="text-center mt-4">
                <span class="auth-link" onclick="closeChangePasswordModal()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAk4mKgcX33bl-z35AB0J-2KHq7aicLnv0",
            authDomain: "kuma-project-5d48d.firebaseapp.com",
            projectId: "kuma-project-5d48d",
            storageBucket: "kuma-project-5d48d.firebasestorage.app",
            messagingSenderId: "144116159091",
            appId: "1:144116159091:web:44ea6d2773c98b464c5006",
            measurementId: "G-8S286PK7LT"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ==================== AUTH FUNCTIONS ====================
        function showForm(form) {
            ['loginForm', 'registerForm', 'forgotForm', 'changePassForm'].forEach(f => document.getElementById(f).classList.add('hidden'));
            document.getElementById(form + (form === 'login' ? 'Form' : form === 'register' ? 'Form' : form === 'forgot' ? 'Form' : 'Form')).classList.remove('hidden');
            const formMap = { login: 'loginForm', register: 'registerForm', forgot: 'forgotForm', changePass: 'changePassForm' };
            document.getElementById(formMap[form]).classList.remove('hidden');
            hideAuthMessage();
        }

        function showAuthMessage(msg, isError = false) {
            const el = document.getElementById('authMessage');
            el.textContent = msg;
            el.className = `mt-4 p-3 rounded-xl text-center text-sm font-medium ${isError ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-600'}`;
            el.classList.remove('hidden');
        }
        function hideAuthMessage() { document.getElementById('authMessage').classList.add('hidden'); }

        async function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const pass = document.getElementById('loginPassword').value;
            if (!email || !pass) return showAuthMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', true);
            try {
                await auth.signInWithEmailAndPassword(email, pass);
                setLoginTimestamp();
                showAuthMessage('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏°‡∏µ‡πâ‡∏¢‡∏ß üêæ');
            } catch (e) {
                showAuthMessage(getErrorMessage(e.code), true);
            }
        }

        async function doGoogleLogin() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await auth.signInWithPopup(provider);
                        setLoginTimestamp();
                } catch (popupErr) {
                    if (popupErr.code === 'auth/popup-blocked' || popupErr.code === 'auth/popup-closed-by-user' || popupErr.code === 'auth/cancelled-popup-request') {
                        showAuthMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á...', false);
                        await auth.signInWithRedirect(provider);
                    } else {
                        throw popupErr;
                    }
                }
            } catch (e) {
                console.error('Google Login Error:', e);
                if (e.code === 'auth/unauthorized-domain') {
                    showAuthMessage('‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡πÉ‡∏ô Firebase Console > Authentication > Settings > Authorized domains', true);
                } else {
                    showAuthMessage(getErrorMessage(e.code) || e.message, true);
                }
            }
        }

        async function doRegister() {
            const name = document.getElementById('regDisplayName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pass = document.getElementById('regPassword').value;
            const pass2 = document.getElementById('regPasswordConfirm').value;
            if (!name || !email || !pass) return showAuthMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', true);
            if (pass !== pass2) return showAuthMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', true);
            if (pass.length < 6) return showAuthMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß', true);
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                setLoginTimestamp();
                await cred.user.updateProfile({ displayName: name });
                showAuthMessage('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà üê±‚ú®');
            } catch (e) {
                showAuthMessage(getErrorMessage(e.code), true);
            }
        }

        async function doForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();
            if (!email) return showAuthMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•', true);
            try {
                await auth.sendPasswordResetEmail(email);
                showAuthMessage('‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß! üìß ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏µ‡πâ‡∏¢‡∏ß');
            } catch (e) {
                showAuthMessage(getErrorMessage(e.code), true);
            }
        }

        async function doChangePassword() {
            const oldPass = document.getElementById('oldPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const newPass2 = document.getElementById('newPasswordConfirm').value;
            if (!oldPass || !newPass) return showAuthMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', true);
            if (newPass !== newPass2) return showAuthMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', true);
            if (newPass.length < 6) return showAuthMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß', true);
            try {
                const user = auth.currentUser;
                const cred = firebase.auth.EmailAuthProvider.credential(user.email, oldPass);
                await user.reauthenticateWithCredential(cred);
                await user.updatePassword(newPass);
                showAuthMessage('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üîê‚úÖ');
            } catch (e) {
                showAuthMessage(getErrorMessage(e.code), true);
            }
        }

        function doLogout() {
                localStorage.removeItem('loginTimestamp');
            auth.signOut();
        }

        // ==================== CHANGE PASSWORD MODAL ====================
        function showChangePasswordModal() {
            document.getElementById('changePassModal').classList.remove('hidden');
            document.getElementById('modalOldPassword').value = '';
            document.getElementById('modalNewPassword').value = '';
            document.getElementById('modalNewPasswordConfirm').value = '';
            document.getElementById('modalChangePassMsg').classList.add('hidden');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePassModal').classList.add('hidden');
        }

        async function doChangePasswordModal() {
            const oldPass = document.getElementById('modalOldPassword').value;
            const newPass = document.getElementById('modalNewPassword').value;
            const newPass2 = document.getElementById('modalNewPasswordConfirm').value;
            const msgEl = document.getElementById('modalChangePassMsg');

            if (!oldPass || !newPass) { msgEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'; msgEl.className = 'mt-4 p-3 rounded-xl text-center text-sm font-medium bg-red-50 text-red-500'; msgEl.classList.remove('hidden'); return; }
            if (newPass !== newPass2) { msgEl.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô'; msgEl.className = 'mt-4 p-3 rounded-xl text-center text-sm font-medium bg-red-50 text-red-500'; msgEl.classList.remove('hidden'); return; }
            if (newPass.length < 6) { msgEl.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß'; msgEl.className = 'mt-4 p-3 rounded-xl text-center text-sm font-medium bg-red-50 text-red-500'; msgEl.classList.remove('hidden'); return; }
            try {
                const user = auth.currentUser;
                const cred = firebase.auth.EmailAuthProvider.credential(user.email, oldPass);
                await user.reauthenticateWithCredential(cred);
                await user.updatePassword(newPass);
                msgEl.textContent = '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üîê‚úÖ';
                msgEl.className = 'mt-4 p-3 rounded-xl text-center text-sm font-medium bg-green-50 text-green-600';
                msgEl.classList.remove('hidden');
                setTimeout(() => closeChangePasswordModal(), 2000);
            } catch (e) {
                msgEl.textContent = getErrorMessage(e.code);
                msgEl.className = 'mt-4 p-3 rounded-xl text-center text-sm font-medium bg-red-50 text-red-500';
                msgEl.classList.remove('hidden');
            }
        }

        function backToMembers() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('membersArea').classList.remove('hidden');
        }

        function getErrorMessage(code) {
            const msgs = {
                'auth/wrong-password': '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                'auth/user-not-found': '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ',
                'auth/email-already-in-use': '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
                'auth/invalid-email': '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                'auth/weak-password': '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß',
                'auth/too-many-requests': '‡∏•‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                'auth/popup-closed-by-user': '‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Google ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î',
                'auth/invalid-credential': '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
            };
            return msgs[code] || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + code;
        }

        // ==================== SESSION EXPIRY (30 min) ====================
        const SESSION_TIMEOUT_MS = 30 * 60 * 1000; // 30 minutes

        function setLoginTimestamp() {
            localStorage.setItem("loginTimestamp", Date.now().toString());
        }

        function checkSessionExpiry() {
            const loginTime = parseInt(localStorage.getItem("loginTimestamp") || "0");
            if (!loginTime) return false;
            const elapsed = Date.now() - loginTime;
            if (elapsed >= SESSION_TIMEOUT_MS) {
                localStorage.removeItem("loginTimestamp");
                auth.signOut();
                showToast("\u23F0 \u0E40\u0E0B\u0E2A\u0E0A\u0E31\u0E19\u0E2B\u0E21\u0E14\u0E2D\u0E32\u0E22\u0E38 (30 \u0E19\u0E32\u0E17\u0E35) \u0E01\u0E23\u0E38\u0E13\u0E32\u0E40\u0E02\u0E49\u0E32\u0E2A\u0E39\u0E48\u0E23\u0E30\u0E1A\u0E1A\u0E43\u0E2B\u0E21\u0E48", true);
                return true;
            }
            return false;
        }

        // Check session expiry every minute
        setInterval(() => {
            if (auth.currentUser) checkSessionExpiry();
        }, 60 * 1000);

        // ==================== AUTH STATE OBSERVER ====================
        auth.onAuthStateChanged(async user => {
            if (user) {
                // Check session expiry
                if (checkSessionExpiry()) return;

                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('membersArea').classList.remove('hidden');
                // Update UI
                document.getElementById('userDisplayName').textContent = user.displayName || user.email;
                document.getElementById('sidebarName').textContent = user.displayName || '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏°‡∏∞';
                document.getElementById('sidebarEmail').textContent = user.email;
                document.getElementById('profileName').value = user.displayName || '';
                document.getElementById('profileEmail').value = user.email;

                // Load photo from Firestore (Base64) or Google photo
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    const photo = userDoc.exists && userDoc.data().photoBase64 ? userDoc.data().photoBase64 : user.photoURL;
                    if (photo) {
                        document.getElementById('userAvatar').src = photo;
                        document.getElementById('userAvatar').classList.remove('hidden');
                        document.getElementById('sidebarAvatar').src = photo;
                        document.getElementById('profilePreview').src = photo;
                        document.getElementById('profilePhoto').value = photo;
                        document.getElementById('removePhotoBtn').classList.remove('hidden');
                    }
                } catch (e) {
                    if (user.photoURL) {
                        document.getElementById('userAvatar').src = user.photoURL;
                        document.getElementById('userAvatar').classList.remove('hidden');
                        document.getElementById('sidebarAvatar').src = user.photoURL;
                    }
                }
                loadNotes();
                initPresence(user);
                loadFriends();
                loadAllUsers();
                loadPosts();
                listenFriendRequestBadge();
                // listenUnreadChats called after friends load
            } else {
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('membersArea').classList.add('hidden');
                showForm('login');
            }
        });

        // ==================== PROFILE ====================
        let profilePhotoUrl = '';

        function compressImage(file, maxSize = 200) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > h) { if (w > maxSize) { h = h * maxSize / w; w = maxSize; } }
                        else { if (h > maxSize) { w = w * maxSize / h; h = maxSize; } }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function handleProfilePhoto(file) {
            if (!file || !file.type.startsWith('image/')) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', true); return; }
            if (file.size > 10 * 1024 * 1024) { showToast('‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10MB', true); return; }
            const statusEl = document.getElementById('photoUploadStatus');
            statusEl.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ...';
            statusEl.className = 'text-xs mt-2 text-amber-500 font-medium';
            statusEl.classList.remove('hidden');
            try {
                profilePhotoUrl = await compressImage(file, 200);
                document.getElementById('profilePhoto').value = profilePhotoUrl;
                document.getElementById('profilePreview').src = profilePhotoUrl;
                document.getElementById('removePhotoBtn').classList.remove('hidden');
                const sizeKB = (profilePhotoUrl.length * 0.75 / 1024).toFixed(1);
                statusEl.textContent = `‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß! (${sizeKB} KB) ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô`;
                statusEl.className = 'text-xs mt-2 text-green-500 font-medium';
            } catch (e) {
                statusEl.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message;
                statusEl.className = 'text-xs mt-2 text-red-500 font-medium';
            }
        }

        function removeProfilePhoto() {
            profilePhotoUrl = '';
            document.getElementById('profilePhoto').value = '';
            document.getElementById('profilePreview').src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23fda4af'/%3E%3Ctext x='50' y='60' text-anchor='middle' font-size='40'%3Eüê±%3C/text%3E%3C/svg%3E";
            document.getElementById('removePhotoBtn').classList.add('hidden');
            document.getElementById('photoUploadStatus').classList.add('hidden');
        }

        // Drag & Drop for profile photo
        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = document.getElementById('photoDropZone');
            if (dropZone) {
                dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.borderColor = '#fb7185'; dropZone.style.background = '#fff1f2'; });
                dropZone.addEventListener('dragleave', () => { dropZone.style.borderColor = ''; dropZone.style.background = ''; });
                dropZone.addEventListener('drop', e => {
                    e.preventDefault(); dropZone.style.borderColor = ''; dropZone.style.background = '';
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) handleProfilePhoto(file);
                    else showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≤‡∏Å‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', true);
                });
            }
        });

        // Ctrl+V Paste for profile photo
        document.addEventListener('paste', e => {
            const profileSection = document.getElementById('sectionProfile');
            if (profileSection && !profileSection.classList.contains('hidden')) {
                const items = e.clipboardData.items;
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        e.preventDefault();
                        handleProfilePhoto(item.getAsFile());
                        break;
                    }
                }
            }
        });

        async function saveProfile() {
            const user = auth.currentUser;
            const name = document.getElementById('profileName').value.trim();
            const photo = document.getElementById('profilePhoto').value.trim();
            try {
                // Save photo to Firestore (Base64)
                await db.collection('users').doc(user.uid).set({
                    displayName: name,
                    email: user.email,
                    photoBase64: photo || null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                // Sync photo to presence
                await db.collection('presence').doc(user.uid).update({
                    displayName: name,
                    photo: photo || null
                });
                // Clear photo cache
                photoCache[user.uid] = photo || null;

                await user.updateProfile({ displayName: name });
                document.getElementById('userDisplayName').textContent = name;
                document.getElementById('sidebarName').textContent = name;
                if (photo) {
                    document.getElementById('userAvatar').src = photo;
                    document.getElementById('sidebarAvatar').src = photo;
                    document.getElementById('userAvatar').classList.remove('hidden');
                }
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üê±');
            } catch (e) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, true);
            }
        }

        // ==================== SECTIONS NAV ====================
        const allSections = ['Notes', 'Chat', 'Friends', 'Posts', 'Profile'];
        function showSection(section) {
            allSections.forEach(s => document.getElementById('section' + s).classList.add('hidden'));
            document.getElementById('section' + section.charAt(0).toUpperCase() + section.slice(1)).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (event && event.target) event.target.closest('.nav-item')?.classList.add('active');
        }

        // ==================== NOTES SYSTEM ====================
        let notes = [];
        let currentNoteId = null;
        let quill = null;
        let currentAttachments = [];

        // Initialize Quill
        function initQuill() {
            if (quill) return;
            quill = new Quill('#quillEditor', {
                theme: 'snow',
                placeholder: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Note ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà... üìù',
                modules: {
                    toolbar: [
                        [{ header: [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ color: [] }, { background: [] }],
                        [{ list: 'ordered' }, { list: 'bullet' }],
                        ['blockquote', 'code-block'],
                        ['link', 'image', 'video'],
                        [{ align: [] }],
                        ['clean']
                    ]
                }
            });
        }

        async function loadNotes() {
            const user = auth.currentUser;
            if (!user) return;
            try {
                const snap = await db.collection('users').doc(user.uid).collection('notes')
                    .orderBy('updatedAt', 'desc').get();
                notes = [];
                snap.forEach(doc => notes.push({ id: doc.id, ...doc.data() }));
                renderNoteList();
            } catch (e) { console.error('Load notes error:', e); }
        }

        function renderNoteList() {
            const list = document.getElementById('noteList');
            if (notes.length === 0) {
                list.innerHTML = '<div class="text-center py-10 text-rose-200 col-span-full"><div class="text-5xl mb-2">üìã</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Note ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡πÄ‡∏•‡∏¢!</p></div>';
                return;
            }
            list.innerHTML = notes.map(n => `
                <div class="note-card ${currentNoteId === n.id ? 'active' : ''}" onclick="openNote('${n.id}')">
                    <h3 class="font-bold text-gray-700 mb-1 truncate">${escapeHtml(n.title || 'Untitled Note')}</h3>
                    <p class="text-xs text-gray-400 mb-2">${n.updatedAt ? new Date(n.updatedAt.seconds * 1000).toLocaleString('th-TH') : ''}</p>
                    <p class="text-sm text-gray-500 line-clamp-2">${(n.textPreview || '').substring(0, 80)}...</p>
                    <div class="flex justify-between items-center mt-2">
                        <div class="flex gap-1">
                            ${n.hasDrawing ? '<span class="text-xs bg-purple-100 text-purple-500 px-2 py-0.5 rounded-full">üé® ‡∏ß‡∏≤‡∏î</span>' : ''}
                            ${(n.attachments || []).length > 0 ? '<span class="text-xs bg-blue-100 text-blue-500 px-2 py-0.5 rounded-full">üìé ' + n.attachments.length + '</span>' : ''}
                        </div>
                        <button onclick="event.stopPropagation();deleteNote('${n.id}')" class="text-red-300 hover:text-red-500 text-xs">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function createNewNote() {
            initQuill();
            currentNoteId = null;
            currentAttachments = [];
            document.getElementById('noteTitle').value = '';
            quill.setContents([]);
            clearCanvas();
            document.getElementById('attachmentList').innerHTML = '';
            document.getElementById('noteEditor').classList.remove('hidden');
            switchEditorTab('write');
        }

        async function openNote(id) {
            initQuill();
            const note = notes.find(n => n.id === id);
            if (!note) return;
            currentNoteId = id;
            currentAttachments = note.attachments || [];
            document.getElementById('noteTitle').value = note.title || '';
            quill.setContents(note.content ? JSON.parse(note.content) : []);

            // Load drawing
            if (note.drawingData) {
                const canvas = document.getElementById('drawingCanvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); };
                img.src = note.drawingData;
            } else {
                clearCanvas();
            }

            renderAttachments();
            document.getElementById('noteEditor').classList.remove('hidden');
            switchEditorTab('write');
            renderNoteList();
        }

        async function saveCurrentNote() {
            const user = auth.currentUser;
            if (!user) return;
            const title = document.getElementById('noteTitle').value.trim() || 'Untitled Note';
            const content = JSON.stringify(quill.getContents());
            const textPreview = quill.getText().substring(0, 200);
            const canvas = document.getElementById('drawingCanvas');
            const drawingData = canvas.toDataURL();
            const hasDrawing = canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height).data.some((v, i) => i % 4 === 3 && v > 0);

            const noteData = {
                title, content, textPreview, drawingData: hasDrawing ? drawingData : null,
                hasDrawing, attachments: currentAttachments,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                const ref = db.collection('users').doc(user.uid).collection('notes');
                if (currentNoteId) {
                    await ref.doc(currentNoteId).update(noteData);
                } else {
                    noteData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    const docRef = await ref.add(noteData);
                    currentNoteId = docRef.id;
                }
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Note ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üíæüêæ');
                await loadNotes();
            } catch (e) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, true);
            }
        }

        async function deleteNote(id) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö Note ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?')) return;
            try {
                await db.collection('users').doc(auth.currentUser.uid).collection('notes').doc(id).delete();
                if (currentNoteId === id) closeEditor();
                showToast('‡∏•‡∏ö Note ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üóëÔ∏è');
                await loadNotes();
            } catch (e) { showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message, true); }
        }

        function closeEditor() {
            document.getElementById('noteEditor').classList.add('hidden');
            currentNoteId = null;
        }

        // ==================== EDITOR TABS ====================
        function switchEditorTab(tab) {
            ['Write', 'Draw', 'Attach'].forEach(t => {
                document.getElementById('editor' + t).classList.add('hidden');
                document.getElementById('tab' + t).classList.remove('active');
            });
            document.getElementById('editor' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');

            if (tab === 'draw') initCanvas();
        }

        // ==================== DRAWING CANVAS ====================
        let drawCtx, isDrawing = false, drawTool = 'pen', drawHistory = [], startX, startY;

        function initCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            if (!drawCtx) {
                drawCtx = canvas.getContext('2d');
                canvas.addEventListener('mousedown', startDraw);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', endDraw);
                canvas.addEventListener('mouseleave', endDraw);
                // Touch support
                canvas.addEventListener('touchstart', e => { e.preventDefault(); startDraw(getTouchPos(e)); });
                canvas.addEventListener('touchmove', e => { e.preventDefault(); draw(getTouchPos(e)); });
                canvas.addEventListener('touchend', e => { e.preventDefault(); endDraw(); });
            }
        }

        function getTouchPos(e) {
            const rect = e.target.getBoundingClientRect();
            const t = e.touches[0];
            return { offsetX: t.clientX - rect.left, offsetY: t.clientY - rect.top };
        }

        function startDraw(e) {
            isDrawing = true;
            startX = e.offsetX;
            startY = e.offsetY;
            if (drawTool === 'pen' || drawTool === 'eraser') {
                drawCtx.beginPath();
                drawCtx.moveTo(startX, startY);
            }
            if (drawTool === 'text') {
                const text = prompt('‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:');
                if (text) {
                    drawCtx.font = document.getElementById('drawSize').value * 4 + 'px Noto Sans Thai';
                    drawCtx.fillStyle = document.getElementById('drawColor').value;
                    drawCtx.fillText(text, startX, startY);
                    saveCanvasState();
                }
                isDrawing = false;
            }
        }

        function draw(e) {
            if (!isDrawing) return;
            const color = document.getElementById('drawColor').value;
            const size = parseInt(document.getElementById('drawSize').value);

            if (drawTool === 'pen') {
                drawCtx.strokeStyle = color;
                drawCtx.lineWidth = size;
                drawCtx.lineCap = 'round';
                drawCtx.lineJoin = 'round';
                drawCtx.lineTo(e.offsetX, e.offsetY);
                drawCtx.stroke();
            } else if (drawTool === 'eraser') {
                drawCtx.strokeStyle = 'white';
                drawCtx.lineWidth = size * 4;
                drawCtx.lineCap = 'round';
                drawCtx.lineTo(e.offsetX, e.offsetY);
                drawCtx.stroke();
            }
        }

        function endDraw(e) {
            if (!isDrawing) return;
            isDrawing = false;

            if (['rect', 'circle', 'arrow'].includes(drawTool) && e) {
                const color = document.getElementById('drawColor').value;
                const size = parseInt(document.getElementById('drawSize').value);
                drawCtx.strokeStyle = color;
                drawCtx.lineWidth = size;

                if (drawTool === 'rect') {
                    drawCtx.strokeRect(startX, startY, e.offsetX - startX, e.offsetY - startY);
                } else if (drawTool === 'circle') {
                    const rx = Math.abs(e.offsetX - startX) / 2;
                    const ry = Math.abs(e.offsetY - startY) / 2;
                    drawCtx.beginPath();
                    drawCtx.ellipse(startX + (e.offsetX - startX) / 2, startY + (e.offsetY - startY) / 2, rx, ry, 0, 0, 2 * Math.PI);
                    drawCtx.stroke();
                } else if (drawTool === 'arrow') {
                    drawCtx.beginPath();
                    drawCtx.moveTo(startX, startY);
                    drawCtx.lineTo(e.offsetX, e.offsetY);
                    drawCtx.stroke();
                    // Arrowhead
                    const angle = Math.atan2(e.offsetY - startY, e.offsetX - startX);
                    drawCtx.beginPath();
                    drawCtx.moveTo(e.offsetX, e.offsetY);
                    drawCtx.lineTo(e.offsetX - 15 * Math.cos(angle - 0.4), e.offsetY - 15 * Math.sin(angle - 0.4));
                    drawCtx.moveTo(e.offsetX, e.offsetY);
                    drawCtx.lineTo(e.offsetX - 15 * Math.cos(angle + 0.4), e.offsetY - 15 * Math.sin(angle + 0.4));
                    drawCtx.stroke();
                }
            }
            saveCanvasState();
        }

        function setDrawTool(tool) {
            drawTool = tool;
            document.querySelectorAll('#editorDraw .draw-tool').forEach(el => el.classList.remove('active'));
            document.getElementById('tool' + tool.charAt(0).toUpperCase() + tool.slice(1)).classList.add('active');
        }

        function clearCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawHistory = [];
            }
        }

        function saveCanvasState() {
            const canvas = document.getElementById('drawingCanvas');
            drawHistory.push(canvas.toDataURL());
            if (drawHistory.length > 30) drawHistory.shift();
        }

        function undoCanvas() {
            if (drawHistory.length < 2) { clearCanvas(); return; }
            drawHistory.pop();
            const img = new Image();
            img.onload = () => {
                const canvas = document.getElementById('drawingCanvas');
                drawCtx.clearRect(0, 0, canvas.width, canvas.height);
                drawCtx.drawImage(img, 0, 0);
            };
            img.src = drawHistory[drawHistory.length - 1];
        }

        // ==================== FILE ATTACHMENTS ====================
        async function handleFileUpload(input) {
            const user = auth.currentUser;
            if (!user) return;
            const files = Array.from(input.files);

            for (const file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    showToast('‡πÑ‡∏ü‡∏•‡πå ' + file.name + ' ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10MB', true);
                    continue;
                }
                try {
                    showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ' + file.name + '...');
                    const ref = storage.ref(`users/${user.uid}/notes/${Date.now()}_${file.name}`);
                    await ref.put(file);
                    const url = await ref.getDownloadURL();
                    currentAttachments.push({
                        name: file.name,
                        url: url,
                        type: file.type,
                        size: file.size
                    });
                    renderAttachments();
                    showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ' + file.name + ' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìé');
                } catch (e) {
                    showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + e.message, true);
                }
            }
            input.value = '';
        }

        function renderAttachments() {
            const list = document.getElementById('attachmentList');
            if (currentAttachments.length === 0) { list.innerHTML = ''; return; }
            list.innerHTML = currentAttachments.map((a, i) => {
                let preview = '';
                if (a.type && a.type.startsWith('image/')) {
                    preview = `<img src="${a.url}" class="w-full h-32 object-cover rounded-lg mb-2" alt="${escapeHtml(a.name)}">`;
                } else if (a.type && a.type.startsWith('video/')) {
                    preview = `<video src="${a.url}" controls class="w-full h-32 rounded-lg mb-2"></video>`;
                }
                return `
                    <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
                        ${preview}
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm font-medium text-gray-700">${escapeHtml(a.name)}</p>
                                <p class="text-xs text-gray-400">${(a.size / 1024).toFixed(1)} KB</p>
                            </div>
                            <div class="flex gap-2">
                                <a href="${a.url}" target="_blank" class="text-blue-500 text-xs hover:underline">‡πÄ‡∏õ‡∏¥‡∏î</a>
                                <button onclick="removeAttachment(${i})" class="text-red-400 text-xs hover:text-red-600">‡∏•‡∏ö</button>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        function removeAttachment(idx) {
            currentAttachments.splice(idx, 1);
            renderAttachments();
        }

        // ==================== UTILS ====================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function showToast(msg, isError = false) {
            const t = document.createElement('div');
            t.className = 'toast-msg';
            if (isError) t.style.background = '#ef4444';
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        const defaultAvatarSvg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23fda4af'/%3E%3Ctext x='50' y='60' text-anchor='middle' font-size='40'%3Eüê±%3C/text%3E%3C/svg%3E";
        function avatarImg(photo, size = 10) {
            const src = photo || defaultAvatarSvg;
            return `<img src="${src}" class="w-${size} h-${size} rounded-full object-cover border-2 border-rose-200 shrink-0" onerror="this.src='${defaultAvatarSvg}'">`;
        }

        // photo cache for lookups
        let photoCache = {};
        async function getUserPhoto(uid) {
            if (photoCache[uid]) return photoCache[uid];
            try {
                const doc = await db.collection('users').doc(uid).get();
                const photo = doc.exists && doc.data().photoBase64 ? doc.data().photoBase64 : null;
                if (photo) photoCache[uid] = photo;
                return photo;
            } catch (e) { return null; }
        }

        function timeAgo(date) {
            if (!date) return '';
            const d = date.seconds ? new Date(date.seconds * 1000) : new Date(date);
            const diff = (Date.now() - d.getTime()) / 1000;
            if (diff < 60) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
            if (diff < 3600) return Math.floor(diff / 60) + ' ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß';
            if (diff < 86400) return Math.floor(diff / 3600) + ' ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß';
            return Math.floor(diff / 86400) + ' ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß';
        }

        // ==================== ONLINE PRESENCE ====================
        let presenceInterval, presenceRefreshInterval;
        const STALE_TIMEOUT_MS = 2 * 60 * 1000; // 2 minutes
        function isStaleOnline(data) {
            if (!data.online) return false; // already offline
            if (!data.lastSeen) return true; // no lastSeen = stale
            const lastSeenMs = data.lastSeen.toMillis ? data.lastSeen.toMillis() : 0;
            return (Date.now() - lastSeenMs) > STALE_TIMEOUT_MS;
        }
        function getRealOnline(data) {
            return (data.online || false) && !isStaleOnline(data);
        }
        function initPresence(user) {
            // Set online with photo
            const presRef = db.collection('presence').doc(user.uid);
            const photoVal = document.getElementById('profilePhoto').value || null;
            presRef.set({
                uid: user.uid,
                displayName: user.displayName || user.email,
                email: user.email,
                photo: photoVal,
                online: true,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            // Heartbeat every 30s
            clearInterval(presenceInterval);
            presenceInterval = setInterval(() => {
                if (auth.currentUser) presRef.update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp(), online: true });
            }, 30000);
            // Set offline on close ‚Äî use both beforeunload + visibilitychange for reliability
            const goOffline = () => presRef.update({ online: false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(() => {});
            window.addEventListener('beforeunload', goOffline);
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    goOffline();
                } else if (document.visibilityState === 'visible' && auth.currentUser) {
                    presRef.update({ online: true, lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
                }
            });
            // Listen to all presence (with stale check)
            let latestPresenceSnap = null;
            function renderPresenceList(snap) {
                const onlineEl = document.getElementById('onlineList');
                const offlineEl = document.getElementById('offlineList');
                let onlineHtml = '', offlineHtml = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    if (doc.id === user.uid) return;
                    const realOnline = getRealOnline(d);
                    const name = escapeHtml(d.displayName || d.email || '???');
                    const avatarSrc = d.photo || defaultAvatarSvg;
                    const item = `<div class="flex items-center gap-2 text-xs py-1"><img src="${avatarSrc}" class="w-6 h-6 rounded-full object-cover border border-rose-200 shrink-0" onerror="this.src='${defaultAvatarSvg}'"><span class="truncate ${realOnline ? 'text-gray-700 font-medium' : 'text-gray-400'}">${name}</span></div>`;
                    if (realOnline) onlineHtml += item; else offlineHtml += item;
                });
                onlineEl.innerHTML = onlineHtml || '<p class="text-xs text-gray-300">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</p>';
                offlineEl.innerHTML = offlineHtml || '<p class="text-xs text-gray-300">-</p>';
            }
            db.collection('presence').onSnapshot(snap => {
                latestPresenceSnap = snap;
                renderPresenceList(snap);
            });
            // Periodic re-render to catch stale users (every 60s)
            clearInterval(presenceRefreshInterval);
            presenceRefreshInterval = setInterval(() => {
                if (latestPresenceSnap) renderPresenceList(latestPresenceSnap);
            }, 60000);
        }

        // ==================== FRIENDS ====================
        let friendsList = [];
        function loadFriends() {
            const uid = auth.currentUser.uid;
            // Listen for friend requests TO me
            db.collection('friendRequests').where('toUid', '==', uid).where('status', '==', 'pending')
                .onSnapshot(snap => {
                    const pDiv = document.getElementById('pendingRequests');
                    const pList = document.getElementById('pendingList');
                    if (snap.empty) { pDiv.classList.add('hidden'); return; }
                    pDiv.classList.remove('hidden');
                    pList.innerHTML = '';
                    snap.forEach(doc => {
                        const d = doc.data();
                        pList.innerHTML += `<div class="flex justify-between items-center bg-amber-50 p-3 rounded-xl border border-amber-200">
                            <span class="text-sm font-medium">${escapeHtml(d.fromName || d.fromEmail)}</span>
                            <div class="flex gap-2">
                                <button onclick="acceptFriend('${doc.id}','${d.fromUid}')" class="bg-green-500 text-white text-xs px-3 py-1 rounded-lg font-bold">‚úÖ ‡∏£‡∏±‡∏ö</button>
                                <button onclick="rejectFriend('${doc.id}')" class="bg-red-100 text-red-500 text-xs px-3 py-1 rounded-lg font-bold">‚ùå</button>
                            </div></div>`;
                    });
                });
            // Listen for accepted friends
            db.collection('friends').where('users', 'array-contains', uid)
                .onSnapshot(async snap => {
                    friendsList = [];
                    const fList = document.getElementById('friendList');
                    if (snap.empty) { fList.innerHTML = '<p class="text-gray-300 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‚Äî ‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡∏™‡∏¥!</p>'; return; }
                    friendsList = await Promise.all(snap.docs.map(async docSnap => {
                        const d = docSnap.data();
                        const fUid = d.users.find(u => u !== uid);
                        const fName = d.names[fUid] || 'friend';
                        const fPhoto = d.photos ? d.photos[fUid] : await getUserPhoto(fUid);
                        let isOnline = false;
                        try { const pSnap = await db.collection('presence').doc(fUid).get(); if (pSnap.exists) isOnline = getRealOnline(pSnap.data()); } catch(e){}
                        return { uid: fUid, name: fName, photo: fPhoto, docId: docSnap.id, online: isOnline };
                    }));
                    fList.innerHTML = friendsList.map(f => {
                        const fAvatar = f.photo || defaultAvatarSvg;
                        return `<div class="member-card flex items-center gap-3 p-3">
                        <div class="relative">
                            <img src="${fAvatar}" class="w-10 h-10 rounded-full object-cover border-2 border-rose-200" onerror="this.src='${defaultAvatarSvg}'">
                            <span class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 rounded-full border-2 border-white ${f.online ? 'bg-green-400' : 'bg-gray-300'}"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-sm text-gray-700 truncate">${escapeHtml(f.name)}</p>
                            <p class="text-xs ${f.online ? 'text-green-500' : 'text-gray-400'}">${f.online ? 'üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå' : '‚ö´ ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå'}</p>
                        </div>
                        <button onclick="openPrivateChat('${f.uid}','${escapeHtml(f.name)}')" class="bg-green-100 text-green-600 text-xs px-3 py-1 rounded-lg font-bold shrink-0">üí¨ ‡πÅ‡∏ä‡∏ó</button>
                    </div>`;
                    }).join('');
                    loadChatList();
                    _refreshAllUsers();
                    listenUnreadChats();
                    listenFriendRequestBadge();
                });
        }

        // ==================== ALL USERS BOARD ====================
        function loadAllUsers() {
            const uid = auth.currentUser.uid;
            db.collection('presence').onSnapshot(snap => {
                const allList = document.getElementById('allUsersList');
                allList.innerHTML = '';
                snap.forEach(async doc => {
                    const d = doc.data();
                    if (doc.id === uid) return; // Skip self
                    const name = escapeHtml(d.displayName || d.email || '???');
                    const userPhoto = d.photo || defaultAvatarSvg;
                    const isOnline = getRealOnline(d);
                    const isFriend = friendsList.some(f => f.uid === doc.id);
                    let actionBtn = '';
                    if (isFriend) {
                        actionBtn = `<button onclick="openPrivateChat('${doc.id}','${name}')" class="bg-green-100 text-green-600 text-xs px-3 py-1 rounded-lg font-bold shrink-0">üí¨ ‡πÅ‡∏ä‡∏ó</button>`;
                    } else {
                        actionBtn = `<button onclick="addFriendDirect('${doc.id}','${escapeHtml(d.email)}')" class="bg-rose-500 text-white text-xs px-3 py-1 rounded-lg font-bold shrink-0 hover:bg-rose-600">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</button>`;
                    }
                    allList.innerHTML += `<div class="member-card flex items-center gap-3 p-3">
                        <div class="relative">
                            <img src="${userPhoto}" class="w-10 h-10 rounded-full object-cover border-2 border-rose-200" onerror="this.src='${defaultAvatarSvg}'">
                            <span class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 rounded-full border-2 border-white ${isOnline ? 'bg-green-400' : 'bg-gray-300'}"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-sm text-gray-700 truncate">${name}</p>
                            <p class="text-xs ${isOnline ? 'text-green-500' : 'text-gray-400'}">${isOnline ? 'üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå' : '‚ö´ ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå'}</p>
                        </div>
                        ${actionBtn}
                    </div>`;
                });
            });
        }

        // Re-sync All Users when friends list changes
        function _refreshAllUsers() { if (auth.currentUser) loadAllUsers(); }

        async function addFriendDirect(targetUid, targetEmail) {
            const user = auth.currentUser;
            try {
                // Check if already friends
                const fSnap = await db.collection('friends').where('users', 'array-contains', user.uid).get();
                const alreadyFriend = fSnap.docs.some(d => d.data().users.includes(targetUid));
                if (alreadyFriend) return showToast('‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!', true);
                // Check if request already sent
                const rSnap = await db.collection('friendRequests')
                    .where('fromUid', '==', user.uid).where('toUid', '==', targetUid).where('status', '==', 'pending').get();
                if (!rSnap.empty) return showToast('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö üì®');
                await db.collection('friendRequests').add({
                    fromUid: user.uid, fromName: user.displayName || user.email, fromEmail: user.email,
                    toUid: targetUid, toEmail: targetEmail,
                    status: 'pending', createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß! üì®');
            } catch (e) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, true); }
        }

        async function sendFriendRequest() {
            const email = document.getElementById('addFriendEmail').value.trim();
            if (!email) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•', true);
            const user = auth.currentUser;
            if (email === user.email) return showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ', true);
            try {
                // Find user by email in presence
                const snap = await db.collection('presence').where('email', '==', email).get();
                if (snap.empty) return showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ', true);
                const targetDoc = snap.docs[0];
                // Check if already friends
                const fSnap = await db.collection('friends').where('users', 'array-contains', user.uid).get();
                const alreadyFriend = fSnap.docs.some(d => d.data().users.includes(targetDoc.id));
                if (alreadyFriend) return showToast('‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!', true);
                await db.collection('friendRequests').add({
                    fromUid: user.uid, fromName: user.displayName || user.email, fromEmail: user.email,
                    toUid: targetDoc.id, toEmail: email,
                    status: 'pending', createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('addFriendEmail').value = '';
                showToast('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß! üì®');
            } catch (e) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, true); }
        }

        async function acceptFriend(reqId, fromUid) {
            const user = auth.currentUser;
            try {
                const reqDoc = await db.collection('friendRequests').doc(reqId).get();
                const reqData = reqDoc.data();
                await db.collection('friends').add({
                    users: [user.uid, fromUid],
                    names: { [user.uid]: user.displayName || user.email, [fromUid]: reqData.fromName || reqData.fromEmail },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await db.collection('friendRequests').doc(reqId).update({ status: 'accepted' });
                showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üê±‚ú®');
            } catch (e) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', true); }
        }

        async function rejectFriend(reqId) {
            await db.collection('friendRequests').doc(reqId).update({ status: 'rejected' });
            showToast('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
        }

        // ==================== CHAT ====================
        let currentChatId = null, currentChatType = 'private', chatListener = null, chatTabMode = 'private';

        function showChatTab(tab) {
            chatTabMode = tab;
            document.getElementById('chatTabPrivate').className = `flex-1 text-xs font-bold py-2 rounded-lg ${tab === 'private' ? 'bg-rose-500 text-white' : 'bg-gray-100 text-gray-500'}`;
            document.getElementById('chatTabGroup').className = `flex-1 text-xs font-bold py-2 rounded-lg ${tab === 'group' ? 'bg-rose-500 text-white' : 'bg-gray-100 text-gray-500'}`;
            loadChatList();
        }

        function loadChatList() {
            const list = document.getElementById('chatList');
            if (chatTabMode === 'private') {
                if (friendsList.length === 0) { list.innerHTML = '<p class="text-xs text-gray-300 text-center py-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ä‡∏ó</p>'; return; }
                list.innerHTML = friendsList.map(f => {
                    const friendAvatar = f.photo || defaultAvatarSvg;
                    const unread = unreadChats[f.uid] || 0;
                    return `
                    <div class="flex items-center gap-2 p-2 rounded-lg cursor-pointer hover:bg-rose-50 transition-colors ${currentChatId === getChatId(f.uid) ? 'bg-rose-100' : ''}"
                        onclick="openPrivateChat('${f.uid}','${escapeHtml(f.name)}')">
                        <img src="${friendAvatar}" class="w-8 h-8 rounded-full object-cover border border-rose-200 shrink-0" onerror="this.src='${defaultAvatarSvg}'">
                        <span class="text-sm font-medium truncate flex-1">${escapeHtml(f.name)}</span>
                        ${unread > 0 ? `<span class="friend-badge">${unread}</span>` : ''}
                    </div>`;
                }).join('');
            } else {
                // Group chats
                db.collection('groupChats').where('members', 'array-contains', auth.currentUser.uid)
                    .get().then(snap => {
                        if (snap.empty) { list.innerHTML = '<p class="text-xs text-gray-300 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∏‡πä‡∏õ</p>'; return; }
                        list.innerHTML = '';
                        snap.forEach(doc => {
                            const d = doc.data();
                            list.innerHTML += `<div class="flex items-center gap-2 p-2 rounded-lg cursor-pointer hover:bg-rose-50 ${currentChatId === doc.id ? 'bg-rose-100' : ''}"
                                onclick="openGroupChat('${doc.id}','${escapeHtml(d.name)}')">
                                <div class="w-8 h-8 rounded-full bg-purple-200 flex items-center justify-center text-sm">üë•</div>
                                <span class="text-sm font-medium truncate">${escapeHtml(d.name)}</span>
                            </div>`;
                        });
                    });
            }
        }

        function getChatId(otherUid) {
            const uid = auth.currentUser.uid;
            return [uid, otherUid].sort().join('_');
        }

        function openPrivateChat(otherUid, name) {
            // Navigate to Chat section
            showSection('chat');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => { if (el.textContent.includes('‡πÅ‡∏ä‡∏ó')) el.classList.add('active'); });
            currentChatId = getChatId(otherUid);
            currentChatType = 'private';
            // Find photo from friendsList or cache
            const friend = friendsList.find(f => f.uid === otherUid);
            const friendPhoto = friend?.photo || defaultAvatarSvg;
            document.getElementById('chatHeader').innerHTML = `<img src="${friendPhoto}" class="w-8 h-8 rounded-full object-cover border border-rose-200" onerror="this.src='${defaultAvatarSvg}'"><span class="font-bold text-gray-700">${escapeHtml(name)}</span>`;
            document.getElementById('chatInputArea').classList.remove('hidden');
            showChatTab('private');
            listenMessages('chats');
            loadChatList();
        }

        function openGroupChat(groupId, name) {
            currentChatId = groupId;
            currentChatType = 'group';
            document.getElementById('chatHeader').innerHTML = `<div class="w-8 h-8 rounded-full bg-purple-200 flex items-center justify-center">üë•</div><span class="font-bold text-gray-700">${escapeHtml(name)}</span>`;
            document.getElementById('chatInputArea').classList.remove('hidden');
            listenMessages('groupMessages');
            loadChatList();
        }

        function listenMessages(collection) {
            if (chatListener) chatListener();
            const msgDiv = document.getElementById('chatMessages');
            msgDiv.innerHTML = '<p class="text-center text-gray-300 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
            chatListener = db.collection(collection).doc(currentChatId).collection('messages')
                .orderBy('createdAt', 'asc').limitToLast(100)
                .onSnapshot(snap => {
                    const uid = auth.currentUser.uid;
                    msgDiv.innerHTML = '';
                    if (snap.empty) { msgDiv.innerHTML = '<p class="text-center text-gray-300 text-sm py-10">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢! üêæ</p>'; return; }
                    snap.forEach(doc => {
                        const m = doc.data();
                        const isMe = m.senderUid === uid;
                        const senderAvatar = m.senderPhoto || defaultAvatarSvg;
                        const imgHtml = m.image ? `<img src="${m.image}" class="chat-img-preview" onclick="openLightbox(this.src)">` : '';
                        msgDiv.innerHTML += `<div class="flex ${isMe ? 'justify-end' : 'justify-start'} gap-2">
                            ${!isMe ? `<img src="${senderAvatar}" class="w-8 h-8 rounded-full object-cover border border-rose-200 shrink-0 mt-1" onerror="this.src='${defaultAvatarSvg}'">` : ''}
                            <div class="max-w-xs px-4 py-2 rounded-2xl text-sm ${isMe ? 'bg-rose-500 text-white rounded-br-sm' : 'bg-gray-100 text-gray-700 rounded-bl-sm'}">
                                ${!isMe ? `<p class="text-xs font-bold mb-1 text-rose-400">${escapeHtml(m.senderName)}</p>` : ''}
                                ${m.text ? `<p>${escapeHtml(m.text)}</p>` : ''}
                                ${imgHtml}
                                <p class="text-xs mt-1 ${isMe ? 'text-rose-200' : 'text-gray-400'}">${m.createdAt ? timeAgo(m.createdAt) : ''}</p>
                            </div>
                            ${isMe ? `<img src="${senderAvatar}" class="w-8 h-8 rounded-full object-cover border border-rose-200 shrink-0 mt-1" onerror="this.src='${defaultAvatarSvg}'">` : ''}
                        </div>`;
                    });
                    // Play sound for new messages from others in active chat
                    const lastMsg = snap.docs[snap.docs.length - 1]?.data();
                    if (lastMsg && lastMsg.senderUid !== uid && lastMsg.createdAt) {
                        const msgTime = lastMsg.createdAt.toMillis();
                        const lastHeard = parseInt(localStorage.getItem("lastHeard_" + currentChatId) || "0");
                        if (msgTime > lastHeard) {
                            playNotifSound();
                            localStorage.setItem("lastHeard_" + currentChatId, msgTime.toString());
                        }
                    }
                    msgDiv.scrollTop = msgDiv.scrollHeight;
                    // Mark as read
                    if (currentChatType === 'private') {
                        const otherUid = currentChatId.split('_').find(id => id !== uid);
                        if (otherUid) { unreadChats[otherUid] = 0; updateChatBadge(); loadChatList(); }
                    }
                });
        }

        let chatPendingImage = null;

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text && !chatPendingImage) return;
            if (!currentChatId) return;
            input.value = '';
            const user = auth.currentUser;
            const collection = currentChatType === 'private' ? 'chats' : 'groupMessages';
            try {
                const myPhoto = document.getElementById('profilePhoto').value || null;
                const msgData = {
                    text: text || '', senderUid: user.uid, senderName: user.displayName || user.email,
                    senderPhoto: myPhoto,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                if (chatPendingImage) { msgData.image = chatPendingImage; chatPendingImage = null; document.getElementById('chatImgPreview').classList.add('hidden'); document.getElementById('chatImgPreview').innerHTML = ''; }
                await db.collection(collection).doc(currentChatId).collection('messages').add(msgData);
            } catch (e) { showToast('‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message, true); }
        }

        // Group Chat Modal
        function showNewGroupModal() {
            if (friendsList.length === 0) return showToast('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∏‡πä‡∏õ‡πÑ‡∏î‡πâ', true);
            const memberCheckboxes = friendsList.map(f => `<label class="flex items-center gap-2 text-sm"><input type="checkbox" value="${f.uid}" data-name="${escapeHtml(f.name)}"> ${escapeHtml(f.name)}</label>`).join('');
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'newGroupModal';
            modal.innerHTML = `<div class="modal-content">
                <h2 class="text-xl font-bold text-rose-500 mb-4">üë• ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∏‡πä‡∏õ‡πÉ‡∏´‡∏°‡πà</h2>
                <input type="text" id="groupNameInput" class="auth-input mb-4" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∏‡πä‡∏õ...">
                <p class="text-sm font-medium text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:</p>
                <div class="space-y-2 max-h-40 overflow-y-auto mb-4">${memberCheckboxes}</div>
                <div class="flex gap-2"><button onclick="createGroup()" class="auth-btn auth-btn-primary flex-1">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∏‡πä‡∏õ üêæ</button>
                <button onclick="document.getElementById('newGroupModal').remove()" class="auth-btn flex-1 bg-gray-100 text-gray-500">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div></div>`;
            document.body.appendChild(modal);
        }

        async function createGroup() {
            const name = document.getElementById('groupNameInput').value.trim();
            if (!name) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∏‡πä‡∏õ', true);
            const checks = document.querySelectorAll('#newGroupModal input[type=checkbox]:checked');
            if (checks.length === 0) return showToast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô', true);
            const user = auth.currentUser;
            const members = [user.uid];
            const names = { [user.uid]: user.displayName || user.email };
            checks.forEach(c => { members.push(c.value); names[c.value] = c.dataset.name; });
            try {
                await db.collection('groupChats').add({
                    name, members, names, createdBy: user.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('newGroupModal').remove();
                showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∏‡πä‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üë•');
                showChatTab('group');
            } catch (e) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', true); }
        }

        // ==================== POSTS ====================
        function loadPosts() {
            db.collection('posts').orderBy('createdAt', 'desc').limit(50)
                .onSnapshot(snap => {
                    const feed = document.getElementById('postsFeed');
                    if (snap.empty) { feed.innerHTML = '<p class="text-center text-gray-300 py-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå ‚Äî ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡πÄ‡∏•‡∏¢! üì¢</p>'; return; }
                    feed.innerHTML = '';
                    snap.forEach(doc => {
                        const p = doc.data();
                        const uid = auth.currentUser.uid;
                        const postPhoto = p.authorPhoto || defaultAvatarSvg;
                        feed.innerHTML += `<div class="member-card" id="post_${doc.id}">
                            <div class="flex items-center gap-3 mb-3">
                                <img src="${postPhoto}" class="w-10 h-10 rounded-full object-cover border-2 border-rose-200" onerror="this.src='${defaultAvatarSvg}'">
                                <div><p class="font-bold text-sm text-gray-700">${escapeHtml(p.authorName)}</p>
                                <p class="text-xs text-gray-400">${timeAgo(p.createdAt)}</p></div>
                                ${p.authorUid === uid ? `<button onclick="deletePost('${doc.id}')" class="ml-auto text-red-300 hover:text-red-500 text-xs">üóëÔ∏è</button>` : ''}
                            </div>
                            <p class="text-gray-700 mb-3 whitespace-pre-wrap">${escapeHtml(p.text)}</p>
                            ${p.image ? `<img src="${p.image}" class="post-img mb-3" onclick="openLightbox(this.src)">` : ''}
                            <hr class="border-rose-100 mb-3">
                            <div id="comments_${doc.id}" class="space-y-2 mb-3"></div>
                            <div class="flex gap-2">
                                <input type="text" id="commentInput_${doc.id}" class="auth-input flex-1 !py-2 !text-sm" placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô... üí¨" onkeydown="if(event.key==='Enter')addComment('${doc.id}')">
                                <button onclick="addComment('${doc.id}')" class="bg-rose-100 text-rose-500 px-3 py-1 rounded-lg text-sm font-bold hover:bg-rose-200">üí¨</button>
                            </div></div>`;
                        // Load comments
                        loadComments(doc.id);
                    });
                });
        }

        async function createPost() {
            const text = document.getElementById('newPostText').value.trim();
            if (!text && !postPendingImage) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ', true);
            const user = auth.currentUser;
            const myPhoto = document.getElementById('profilePhoto').value || null;
            try {
                const postData = {
                    text: text || '', authorUid: user.uid, authorName: user.displayName || user.email,
                    authorPhoto: myPhoto,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                if (postPendingImage) { postData.image = postPendingImage; postPendingImage = null; document.getElementById('postImgPreview').classList.add('hidden'); document.getElementById('postImgPreview').innerHTML = ''; }
                await db.collection('posts').add(postData);
                document.getElementById('newPostText').value = '';
                showToast('‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üì¢üêæ');
            } catch (e) { showToast('‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + e.message, true); }
        }

        async function deletePost(postId) {
            if (!confirm('‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ?')) return;
            await db.collection('posts').doc(postId).delete();
            showToast('‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß üóëÔ∏è');
        }

        function loadComments(postId) {
            db.collection('posts').doc(postId).collection('comments')
                .orderBy('createdAt', 'asc').limit(20)
                .onSnapshot(snap => {
                    const cDiv = document.getElementById('comments_' + postId);
                    if (!cDiv) return;
                    cDiv.innerHTML = '';
                    snap.forEach(doc => {
                        const c = doc.data();
                        const commentPhoto = c.authorPhoto || defaultAvatarSvg;
                        cDiv.innerHTML += `<div class="bg-gray-50 rounded-lg px-3 py-2 flex gap-2">
                            <img src="${commentPhoto}" class="w-6 h-6 rounded-full object-cover border border-rose-200 shrink-0 mt-0.5" onerror="this.src='${defaultAvatarSvg}'">
                            <div><span class="text-xs font-bold text-rose-400">${escapeHtml(c.authorName)}</span>
                            <span class="text-xs text-gray-400 ml-2">${timeAgo(c.createdAt)}</span>
                            <p class="text-sm text-gray-600 mt-1">${escapeHtml(c.text)}</p></div></div>`;
                    });
                });
        }

        async function addComment(postId) {
            const input = document.getElementById('commentInput_' + postId);
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            const user = auth.currentUser;
            const myPhoto = document.getElementById('profilePhoto').value || null;
            await db.collection('posts').doc(postId).collection('comments').add({
                text, authorUid: user.uid, authorName: user.displayName || user.email,
                authorPhoto: myPhoto,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // ==================== EMOJI PICKER ====================
        const emojiList = ['üòÄ', 'üòÇ', 'ü•∞', 'üòç', 'üòé', 'ü§©', 'üòä', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'ü§î', 'üôÑ', 'üòè', 'üò¥', 'ü§ó', 'ü´∂', '‚ù§Ô∏è', 'üî•', '‚ú®', 'üíØ', 'üëç', 'üëè', 'üéâ', 'üôè', 'üí™', 'üê±', 'üêæ', 'üêª', 'ü¶ä', 'üå∏', 'üåà', '‚≠ê', '‚òÄÔ∏è', 'üçï', 'üç¶', '‚òï', 'üéµ', 'üì∏', 'üí¨', 'üì¢', '‚úÖ', '‚ùå', '‚ö°', 'üíñ', 'ü•≥', 'üòá', 'ü§≠', 'üòà', 'üíÄ'];
        let postPendingImage = null;
        let unreadChats = {};

        function buildEmojiGrid(targetInputId, pickerId) {
            const picker = document.getElementById(pickerId);
            picker.innerHTML = emojiList.map(e => `<span onclick="insertEmoji('${targetInputId}','${e}','${pickerId}')">${e}</span>`).join('');
        }

        function insertEmoji(inputId, emoji, pickerId) {
            const el = document.getElementById(inputId);
            if (el.tagName === 'TEXTAREA') { el.value += emoji; el.focus(); }
            else if (el.tagName === 'INPUT') { el.value += emoji; el.focus(); }
            document.getElementById(pickerId).classList.remove('show');
        }

        function toggleChatEmoji() {
            const picker = document.getElementById('chatEmojiPicker');
            if (!picker.innerHTML) buildEmojiGrid('chatInput', 'chatEmojiPicker');
            picker.classList.toggle('show');
        }
        function togglePostEmoji() {
            const picker = document.getElementById('postEmojiPicker');
            if (!picker.innerHTML) buildEmojiGrid('newPostText', 'postEmojiPicker');
            if (picker.classList.contains('show')) { picker.classList.remove('show'); return; }
            // Position near the emoji button
            const btn = document.querySelector('[onclick="togglePostEmoji()"]');
            if (btn) {
                const rect = btn.getBoundingClientRect();
                picker.style.left = rect.left + 'px';
                picker.style.top = (rect.bottom + 5) + 'px';
            }
            picker.classList.add('show');
        }

        // ==================== IMAGE UPLOAD FOR CHAT ====================
        async function handleChatImage(input) {
            const file = input.files[0];
            if (!file) return;
            try {
                showToast('‚öôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ...');
                const compressed = await compressImage(file, 800);
                chatPendingImage = compressed;
                const preview = document.getElementById('chatImgPreview');
                preview.classList.remove('hidden');
                preview.innerHTML = `<div class="relative"><img src="${compressed}" class="w-20 h-20 rounded-lg object-cover border-2 border-rose-200"><button onclick="removeChatImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">‚úï</button></div>`;
                showToast('‚úÖ ‡∏£‡∏π‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á!');
            } catch (e) { showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ: ' + e.message, true); }
            input.value = '';
        }
        function removeChatImage() {
            chatPendingImage = null;
            document.getElementById('chatImgPreview').classList.add('hidden');
            document.getElementById('chatImgPreview').innerHTML = '';
        }

        // ==================== IMAGE UPLOAD FOR POSTS ====================
        async function handlePostImage(input) {
            const file = input.files[0];
            if (!file) return;
            try {
                showToast('‚öôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ...');
                const compressed = await compressImage(file, 1200);
                postPendingImage = compressed;
                const preview = document.getElementById('postImgPreview');
                preview.classList.remove('hidden');
                preview.innerHTML = `<div class="relative inline-block"><img src="${compressed}" class="w-40 h-auto rounded-lg border-2 border-rose-200"><button onclick="removePostImage()" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">‚úï</button></div>`;
                showToast('‚úÖ ‡∏£‡∏π‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏û‡∏™‡∏ï‡πå!');
            } catch (e) { showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ: ' + e.message, true); }
            input.value = '';
        }
        function removePostImage() {
            postPendingImage = null;
            document.getElementById('postImgPreview').classList.add('hidden');
            document.getElementById('postImgPreview').innerHTML = '';
        }

        // ==================== IMAGE LIGHTBOX ====================
        function openLightbox(src) {
            const overlay = document.createElement('div');
            overlay.className = 'lightbox-overlay';
            overlay.onclick = () => overlay.remove();
            overlay.innerHTML = `<button class="lightbox-close" onclick="event.stopPropagation();this.parentElement.remove()">‚úï</button><img src="${src}" onclick="event.stopPropagation()">`;
            document.body.appendChild(overlay);
        }

        // ==================== CHAT SOUND & BROWSER NOTIFICATIONS ====================
        let notifSoundEnabled = true;
        let _audioCtx = null;

        // Create AudioContext on first user interaction (required by browsers)
        function getAudioCtx() {
            if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (_audioCtx.state === "suspended") _audioCtx.resume();
            return _audioCtx;
        }
        // Init audio context on any user interaction
        document.addEventListener("click", () => getAudioCtx(), { once: true });
        document.addEventListener("keydown", () => getAudioCtx(), { once: true });

        // Request notification permission
        function requestNotifPermission() {
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }
        }
        // Request on page interaction
        document.addEventListener("click", requestNotifPermission, { once: true });

        // Play cute cat meow notification sound üê±
        function playNotifSound() {
            if (!notifSoundEnabled) return;
            try {
                const ctx = getAudioCtx();
                const now = ctx.currentTime;

                // === Cute "Meow!" sound ===
                // Main meow tone (slides up then down like a real cat)
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = "sine";
                // Start at ~600Hz, slide up to ~900Hz, then back down (meow shape)
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(950, now + 0.12);
                osc.frequency.linearRampToValueAtTime(700, now + 0.3);
                osc.frequency.linearRampToValueAtTime(500, now + 0.45);
                // Volume envelope: quick attack, sustain, fade
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.3, now + 0.03);
                gain.gain.setValueAtTime(0.3, now + 0.15);
                gain.gain.linearRampToValueAtTime(0.15, now + 0.3);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.45);
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(now); osc.stop(now + 0.5);

                // Harmonics for warmth (makes it sound more natural)
                const osc2 = ctx.createOscillator();
                const gain2 = ctx.createGain();
                osc2.type = "triangle";
                osc2.frequency.setValueAtTime(1200, now);
                osc2.frequency.linearRampToValueAtTime(1900, now + 0.12);
                osc2.frequency.linearRampToValueAtTime(1400, now + 0.3);
                osc2.frequency.linearRampToValueAtTime(1000, now + 0.45);
                gain2.gain.setValueAtTime(0, now);
                gain2.gain.linearRampToValueAtTime(0.08, now + 0.03);
                gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.35);
                osc2.connect(gain2); gain2.connect(ctx.destination);
                osc2.start(now); osc2.stop(now + 0.4);

                // Second short "mew" after a tiny pause
                const osc3 = ctx.createOscillator();
                const gain3 = ctx.createGain();
                osc3.type = "sine";
                osc3.frequency.setValueAtTime(750, now + 0.5);
                osc3.frequency.linearRampToValueAtTime(1000, now + 0.58);
                osc3.frequency.linearRampToValueAtTime(650, now + 0.72);
                gain3.gain.setValueAtTime(0, now + 0.5);
                gain3.gain.linearRampToValueAtTime(0.25, now + 0.52);
                gain3.gain.exponentialRampToValueAtTime(0.01, now + 0.72);
                osc3.connect(gain3); gain3.connect(ctx.destination);
                osc3.start(now + 0.5); osc3.stop(now + 0.75);

            } catch(e) { console.log("Sound err:", e); }
        }


        // Toggle notification sound on/off
        function toggleNotifSound() {
            notifSoundEnabled = !notifSoundEnabled;
            const btn = document.getElementById("soundToggleBtn");
            if (btn) {
                if (notifSoundEnabled) {
                    btn.innerHTML = "\uD83D\uDD14 \u0E40\u0E2A\u0E35\u0E22\u0E07\u0E40\u0E1B\u0E34\u0E14";
                    btn.classList.remove("bg-gray-200", "text-gray-400");
                    btn.classList.add("bg-rose-100", "text-rose-400");
                    showToast("\uD83D\uDD14 \u0E40\u0E1B\u0E34\u0E14\u0E40\u0E2A\u0E35\u0E22\u0E07\u0E41\u0E08\u0E49\u0E07\u0E40\u0E15\u0E37\u0E2D\u0E19\u0E41\u0E25\u0E49\u0E27 \uD83D\uDC31");
                } else {
                    btn.innerHTML = "\uD83D\uDD15 \u0E1B\u0E34\u0E14\u0E40\u0E2A\u0E35\u0E22\u0E07";
                    btn.classList.remove("bg-rose-100", "text-rose-400");
                    btn.classList.add("bg-gray-200", "text-gray-400");
                    showToast("\uD83D\uDD15 \u0E1B\u0E34\u0E14\u0E40\u0E2A\u0E35\u0E22\u0E07\u0E41\u0E08\u0E49\u0E07\u0E40\u0E15\u0E37\u0E2D\u0E19\u0E41\u0E25\u0E49\u0E27");
                }
            }
        }
        // Show browser notification (works both focused and unfocused)
        function showBrowserNotif(title, body, icon) {
            if (!("Notification" in window) || Notification.permission !== "granted") return;
            try {
                const n = new Notification(title, {
                    body: body || "\u0e02\u0e49\u0e2d\u0e04\u0e27\u0e32\u0e21\u0e43\u0e2b\u0e21\u0e48",
                    icon: icon || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23fda4af'/%3E%3Ctext x='50' y='65' text-anchor='middle' font-size='50'%3E\uD83D\uDC31%3C/text%3E%3C/svg%3E",
                    tag: "kuma-chat-" + Date.now(),
                    requireInteraction: false
                });
                n.onclick = () => { window.focus(); n.close(); };
                setTimeout(() => n.close(), 6000);
            } catch(e) { console.log("Notif err:", e); }
        }

        // Show in-page toast notification (cute cat style) üê±
        function showChatToast(senderName, text) {
            // Remove existing toast
            document.querySelectorAll(".chat-notif-toast").forEach(t => t.remove());
            const toast = document.createElement("div");
            toast.className = "chat-notif-toast";
            toast.innerHTML = `
                <button class="toast-close" onclick="event.stopPropagation();this.parentElement.remove()">\u2715</button>
                <div style="display:flex;align-items:center">
                    <span class="toast-icon">\uD83D\uDC31</span>
                    <div>
                        <div class="toast-title">\uD83D\uDCAC ${senderName}</div>
                        <div class="toast-body">${text || "\u0e2a\u0e48\u0e07\u0e02\u0e49\u0e2d\u0e04\u0e27\u0e32\u0e21\u0e43\u0e2b\u0e21\u0e48"}</div>
                    </div>
                </div>
            `;
            toast.onclick = () => { toast.remove(); showSection("chat"); };
            document.body.appendChild(toast);
            // Auto dismiss with slide out animation
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = "toastSlideOut 0.3s ease forwards";
                    setTimeout(() => { if (toast.parentNode) toast.remove(); }, 300);
                }
            }, 5000);
        }

        // Combined: play sound + browser notif + in-page toast
        function triggerChatNotif(senderName, messageText, senderPhoto) {
            playNotifSound();
            const body = messageText ? (messageText.length > 60 ? messageText.substring(0, 60) + "..." : messageText) : "\u0e2a\u0e48\u0e07\u0e23\u0e39\u0e1b\u0e20\u0e32\u0e1e \uD83D\uDCF7";
            showBrowserNotif("\uD83D\uDCAC " + senderName, body, senderPhoto);
            showChatToast(senderName, body);
        }

        // ==================== NOTIFICATION BADGES ====================
        function updateBadge(badgeId, count) {
            const badge = document.getElementById(badgeId);
            if (!badge) return;
            if (count > 0) { badge.textContent = count > 99 ? '99+' : count; badge.classList.remove('hidden'); }
            else badge.classList.add('hidden');
        }
        function updateChatBadge() {
            const total = Object.values(unreadChats).reduce((sum, n) => sum + n, 0);
            updateBadge('badgeChat', total);
        }

        // Unread message listeners for each friend
        let unreadListeners = {};
        function listenUnreadChats() {
            const uid = auth.currentUser.uid;
            friendsList.forEach(f => {
                const chatId = getChatId(f.uid);
                if (unreadListeners[chatId]) return; // already listening
                unreadListeners[chatId] = db.collection('chats').doc(chatId).collection('messages')
                    .orderBy('createdAt', 'desc').limit(20)
                    .onSnapshot(snap => {
                        if (currentChatId === chatId) return; // already viewing
                        let count = 0;
                        const lastRead = parseInt(localStorage.getItem('lastRead_' + chatId) || '0');
                        snap.forEach(doc => {
                            const m = doc.data();
                            if (m.senderUid !== uid && m.createdAt && m.createdAt.toMillis() > lastRead) count++;
                        });
                        unreadChats[f.uid] = count;
                        // Trigger sound + notification for truly new messages
                        if (count > 0) {
                            const prevCount = parseInt(localStorage.getItem("prevUnread_" + chatId) || "0");
                            if (count > prevCount) {
                                // Get latest message for notification content
                                const latestMsg = snap.docs[0]?.data();
                                if (latestMsg && latestMsg.senderUid !== uid) {
                                    triggerChatNotif(latestMsg.senderName || f.name, latestMsg.text, latestMsg.senderPhoto);
                                }
                            }
                            localStorage.setItem("prevUnread_" + chatId, count.toString());
                        } else {
                            localStorage.setItem("prevUnread_" + chatId, "0");
                        }
                        updateChatBadge();
                        loadChatList();
                    });
            });
        }

        // Mark chat as read when opening
        const _origOpenChat = openPrivateChat;
        openPrivateChat = function (otherUid, name) {
            _origOpenChat(otherUid, name);
            localStorage.setItem('lastRead_' + getChatId(otherUid), Date.now().toString());
            unreadChats[otherUid] = 0;
            updateChatBadge();
            loadChatList();
        };

        // Friend request badge
        function listenFriendRequestBadge() {
            const uid = auth.currentUser.uid;
            db.collection('friendRequests').where('toUid', '==', uid).where('status', '==', 'pending')
                .onSnapshot(snap => { updateBadge('badgeFriends', snap.size); });
        }

        // Posts badge  
        let lastPostsView = 0;
        function listenPostsBadge() {
            lastPostsView = parseInt(localStorage.getItem('lastPostsView') || '0');
            db.collection('posts').orderBy('createdAt', 'desc').limit(50)
                .onSnapshot(snap => {
                    let newCount = 0;
                    snap.forEach(doc => {
                        const p = doc.data();
                        if (p.createdAt && p.createdAt.toMillis() > lastPostsView && p.authorUid !== auth.currentUser.uid) newCount++;
                    });
                    updateBadge('badgePosts', newCount);
                });
        }

        // Update showSection to clear badges
        const _origShowSection = showSection;
        showSection = function (section) {
            _origShowSection(section);
            if (section === 'friends') updateBadge('badgeFriends', 0);
            if (section === 'posts') {
                lastPostsView = Date.now();
                localStorage.setItem('lastPostsView', lastPostsView.toString());
                updateBadge('badgePosts', 0);
            }
        };

        // Init badges after auth
        setTimeout(() => {
            if (auth.currentUser) {
                listenFriendRequestBadge();
                listenPostsBadge();
                setTimeout(() => listenUnreadChats(), 2000);
            }
        }, 3000);

        // ==================== MOBILE SIDEBAR TOGGLE ====================
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('leftSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }
        // Close sidebar when clicking nav items on mobile
        document.querySelectorAll('.nav-item').forEach(el => {
            el.addEventListener('click', () => {
                if (window.innerWidth < 768) {
                    document.getElementById('leftSidebar').classList.remove('open');
                    document.getElementById('sidebarOverlay').classList.remove('show');
                }
            });
        });

        // ==================== KUMA AI FLOATING CHAT ====================
        let kumaChatHistory = [];
        function toggleKumaChat() {
            document.getElementById('kumaChatPanel').classList.toggle('open');
        }

        async function sendKumaMessage() {
            const input = document.getElementById('kumaInput');
            const msg = input.value.trim();
            if (!msg) return;
            addKumaBubble('user', msg);
            input.value = '';

            const formData = new FormData();
            formData.append('message', msg);
            formData.append('history', JSON.stringify(kumaChatHistory));

            const typingId = addKumaBubble('ai', '<span class="kuma-typing-dot"></span><span class="kuma-typing-dot" style="animation-delay:0.2s"></span><span class="kuma-typing-dot" style="animation-delay:0.4s"></span>', true);

            try {
                const res = await fetch('/api/chat', { method: 'POST', body: formData });
                const data = await res.json();
                document.getElementById(typingId)?.remove();
                if (data.error) {
                    addKumaBubble('ai', '‚ùå ' + data.error);
                } else {
                    if (data.message) addKumaBubble('ai', data.message);
                    kumaChatHistory.push({ role: 'user', parts: [{ text: msg }] });
                    kumaChatHistory.push({ role: 'model', parts: [{ text: data.message || '' }] });
                }
            } catch (err) {
                document.getElementById(typingId)?.remove();
                addKumaBubble('ai', '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ñ‡∏∏‡∏°‡∏∞‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á... üòø');
            }
        }

        function addKumaBubble(role, text, isRaw = false) {
            const container = document.getElementById('kumaMessages');
            const id = 'kuma-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = `kuma-chat-bubble ${role}`;
            if (isRaw) div.innerHTML = text;
            else div.textContent = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }
    </script>

    <!-- KUMA AI Floating Chat -->
    <button class="kuma-fab" onclick="toggleKumaChat()" title="‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏°‡∏∞ AI">üê±</button>
    <div class="kuma-chat-panel" id="kumaChatPanel">
        <div
            style="padding:1rem 1.2rem; border-bottom:2px solid #fecdd3; display:flex; justify-content:space-between; align-items:center; background: linear-gradient(135deg,#fff1f2,#fdf2f8);">
            <div>
                <p class="font-bold text-rose-500">üê± ‡πÄ‡∏≠‡πÄ‡∏à‡∏ô‡∏ó‡πå‡∏ô‡πâ‡∏≠‡∏á‡∏Ñ‡∏∏‡∏°‡∏∞</p>
                <p class="text-xs text-gray-400">‡∏ñ‡∏≤‡∏°‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ!</p>
            </div>
            <button onclick="toggleKumaChat()" class="text-gray-400 hover:text-rose-500 text-xl">‚úï</button>
        </div>
        <div id="kumaMessages" class="flex-1 overflow-y-auto p-3 space-y-2" style="max-height:350px; min-height:200px;">
            <div class="kuma-chat-bubble ai">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏µ‡πâ‡∏¢‡∏ß! üêæ ‡∏ú‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡πÄ‡∏à‡∏ô‡∏ó‡πå‡∏ô‡πâ‡∏≠‡∏á‡∏Ñ‡∏∏‡∏°‡∏∞ ‡∏ñ‡∏≤‡∏°‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡πÄ‡∏°‡∏µ‡πâ‡∏¢‡∏ß!</div>
        </div>
        <div style="padding:0.75rem 1rem; border-top:2px solid #fecdd3; display:flex; gap:8px;">
            <input type="text" id="kumaInput" class="auth-input flex-1 !py-2 !text-sm" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏°‡∏∞..."
                onkeydown="if(event.key==='Enter')sendKumaMessage()">
            <button onclick="sendKumaMessage()"
                class="bg-rose-500 text-white px-3 py-1 rounded-xl text-sm font-bold hover:bg-rose-600">üöÄ</button>
        </div>
    </div>
</body>

</html>