<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏°‡∏ß ‡∏Ö^‚Ä¢Ôªå‚Ä¢^‡∏Ö</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #fff1f2;
        }

        .cat-card {
            background-color: white;
            border: 4px solid #fda4af;
            border-radius: 2.5rem;
        }

        .btn-primary {
            background-color: #fda4af;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #f43f5e;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background-color: #fecdd3;
            cursor: not-allowed;
        }

        .btn-danger {
            background-color: #fee2e2;
            color: #ef4444;
            transition: all 0.2s ease;
        }

        .btn-danger:hover {
            background-color: #fecaca;
        }

        input,
        textarea {
            border: 2px solid #fecdd3;
            border-radius: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #fda4af;
            box-shadow: 0 0 0 3px rgba(253, 164, 175, 0.2);
        }

        .tab-active {
            background-color: #fda4af;
            color: white;
            box-shadow: 0 4px 15px rgba(253, 164, 175, 0.4);
        }

        .tab-inactive {
            background-color: white;
            color: #fda4af;
            border: 2px solid #fecdd3;
        }

        .tab-inactive:hover {
            background-color: #fff1f2;
        }

        .json-block {
            background-color: #1e293b;
            color: #e2e8f0;
            border-radius: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
        }

        .json-key {
            color: #7dd3fc;
        }

        .json-string {
            color: #86efac;
        }

        .json-number {
            color: #fcd34d;
        }

        .json-bool {
            color: #c4b5fd;
        }

        .upload-zone {
            border: 3px dashed #fecdd3;
            border-radius: 1.5rem;
            transition: all 0.3s ease;
        }

        .upload-zone:hover,
        .upload-zone.drag-over {
            border-color: #fda4af;
            background-color: #fff1f2;
        }

        /* Animated Background Cats */
        #cat-atmosphere {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            overflow: hidden;
        }

        .bg-cat {
            position: absolute;
            opacity: 0.15;
            filter: grayscale(0.2);
            animation: float 20s infinite linear;
            user-select: none;
        }

        @keyframes float {
            0% {
                transform: translate(0, 0) rotate(0deg);
            }

            25% {
                transform: translate(15px, 25px) rotate(10deg);
            }

            50% {
                transform: translate(-10px, 40px) rotate(-5deg);
            }

            75% {
                transform: translate(-25px, 15px) rotate(5deg);
            }

            100% {
                transform: translate(0, 0) rotate(0deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* AI Sidebar Styles */
        #ai-sidebar {
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .chat-bubble {
            border-radius: 1.5rem;
            padding: 0.75rem 1rem;
            max-width: 85%;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .chat-bubble.user {
            background-color: #fda4af;
            color: white;
            border-bottom-right-radius: 0.25rem;
            margin-left: auto;
        }

        .chat-bubble.ai {
            background-color: white;
            color: #4b5563;
            border: 2px solid #fecdd3;
            border-bottom-left-radius: 0.25rem;
            margin-right: auto;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #fda4af;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1s infinite alternate;
        }

        @keyframes typing {
            from {
                opacity: 0.3;
                transform: translateY(0);
            }

            to {
                opacity: 1;
                transform: translateY(-4px);
            }
        }

        /* Editable Table Styles */
        [contenteditable="true"] {
            border-bottom: 1px dashed transparent;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        [contenteditable="true"]:hover {
            background-color: #fff1f2;
            border-bottom-color: #fda4af;
        }

        [contenteditable="true"]:focus {
            outline: none;
            background-color: white;
            border: 2px solid #fda4af;
            box-shadow: 0 0 0 3px rgba(253, 164, 175, 0.2);
        }
    </style>
</head>

<body class="min-h-screen pb-20 overflow-x-hidden">
    <!-- AI Sidebar -->
    <div id="ai-sidebar"
        class="fixed left-0 top-0 h-full w-80 bg-white border-r-4 border-rose-200 shadow-2xl flex flex-col -translate-x-full">
        <!-- Toggle Button (Inside) -->
        <button onclick="toggleAI()"
            class="absolute -right-12 top-1/2 -translate-y-1/2 bg-white border-4 border-l-0 border-rose-200 p-2 rounded-r-2xl shadow-lg hover:bg-rose-50 transition-colors group">
            <span id="ai-toggle-icon" class="text-2xl block group-hover:scale-110 transition-transform">üê±</span>
        </button>

        <!-- Header -->
        <div class="p-6 border-b-2 border-rose-100 bg-rose-50/50">
            <h3 class="font-bold text-rose-500 flex items-center gap-2">
                <span class="text-2xl">ü§ñ</span> ‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏°‡∏ß‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ (AI Agent)
            </h3>
            <p class="text-xs text-rose-300 mt-1">‡∏™‡∏±‡πà‡∏á‡∏ú‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á Test Case ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏≤‡∏°‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡πÅ‡∏á‡πâ‡∏ß!</p>
        </div>

        <!-- Chat Content -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 bg-rose-50/20">
            <div class="chat-bubble ai shadow-sm">
                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå! üêæ ‡∏ú‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡πÄ‡∏à‡∏ô‡∏ó‡πå‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏°‡∏ß ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏ô‡∏∞‡πÄ‡∏°‡∏µ‡πâ‡∏¢‡∏ß ‡∏™‡∏±‡πà‡∏á‡∏ú‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô
                "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡∏™‡πÄ‡∏Ñ‡∏™‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢"
            </div>
        </div>

        <!-- Input -->
        <div class="p-4 border-t-2 border-rose-100 bg-white">
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏°‡∏ß..." class="flex-1 p-2 text-sm">
                <button onclick="sendMessage()" class="btn-primary p-2 rounded-xl">
                    <span class="text-xl">üöÄ</span>
                </button>
            </div>
        </div>
    </div>
    <!-- Cat Atmosphere Layer -->
    <div id="cat-atmosphere"></div>
    <div class="max-w-4xl mx-auto">

        <!-- Header -->
        <div class="text-center mb-6">
            <div class="text-4xl mb-2 text-rose-400">‡∏Ö^‚Ä¢Ôªå‚Ä¢^‡∏Ö</div>
            <h1 class="text-3xl font-bold text-rose-500">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏°‡∏ß</h1>
            <p class="text-rose-300">Cat Test Case Builder</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex justify-center gap-3 mb-8">
            <button id="tabPage1" onclick="switchPage(1)"
                class="tab-active px-6 py-3 rounded-full font-bold text-sm transition-all">
                üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö
            </button>
            <button id="tabPage2" onclick="switchPage(2)"
                class="tab-inactive px-6 py-3 rounded-full font-bold text-sm transition-all">
                üîß JSON Payload Generator
            </button>
        </div>

        <!-- ==================== PAGE 1: Test Case Builder ==================== -->
        <div id="page1">
            <div class="cat-card p-8 shadow-2xl relative mb-10">
                <div class="space-y-4">
                    <div>
                        <label for="testCaseName" class="block text-sm font-medium text-rose-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                            (Test Case Name)</label>
                        <input type="text" id="testCaseName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"
                            class="w-full p-3 bg-rose-50">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="testStep" class="block text-sm font-medium text-rose-600 mb-1">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                                (Test Step)</label>
                            <textarea id="testStep" rows="3" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                                class="w-full p-3 bg-rose-50 resize-none"></textarea>
                        </div>
                        <div>
                            <label for="expectedResult"
                                class="block text-sm font-medium text-rose-600 mb-1">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á (Expected
                                Result)</label>
                            <textarea id="expectedResult" rows="3" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                                class="w-full p-3 bg-rose-50 resize-none"></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button id="addStepBtn" disabled class="btn-primary px-8 py-3 rounded-full font-bold shadow-lg">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Add Next Step)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview Table -->
            <div class="bg-white rounded-[2rem] p-6 shadow-xl border-2 border-rose-100">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-rose-500 flex items-center">
                        <span class="mr-2">üìã</span> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (Preview Table)
                    </h2>
                    <div class="flex space-x-2">
                        <a href="/api/testcase-template"
                            class="bg-blue-50 text-blue-500 px-4 py-2 rounded-xl text-sm font-medium hover:bg-blue-100 transition-colors flex items-center">
                            üì• ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                        </a>
                        <button onclick="document.getElementById('importTestCaseInput').click()"
                            class="bg-purple-50 text-purple-500 px-4 py-2 rounded-xl text-sm font-medium hover:bg-purple-100 transition-colors">
                            üìÇ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel
                        </button>
                        <input type="file" id="importTestCaseInput" accept=".xlsx" class="hidden"
                            onchange="importTestCases(this)">
                        <button onclick="saveTestCaseHistory()"
                            class="bg-blue-100 text-blue-600 px-4 py-2 rounded-xl text-sm font-medium hover:bg-blue-200 transition-colors">
                            üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                        </button>
                        <button id="resetBtn"
                            class="bg-rose-50 text-rose-400 px-4 py-2 rounded-xl text-sm font-medium hover:bg-rose-100 transition-colors">
                            ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                        <button id="exportBtn"
                            class="bg-green-100 text-green-600 px-4 py-2 rounded-xl text-sm font-medium hover:bg-green-200 transition-colors hidden">
                            ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b-2 border-rose-50">
                                <th class="py-3 px-4 text-rose-400 font-semibold w-16">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                <th class="py-3 px-4 text-rose-400 font-semibold">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</th>
                                <th class="py-3 px-4 text-rose-400 font-semibold">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</th>
                                <th class="py-3 px-4 text-rose-400 font-semibold">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á</th>
                                <th class="py-3 px-4 text-rose-400 font-semibold w-20 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="testCaseTableBody" class="text-gray-600"></tbody>
                    </table>
                    <div id="emptyState" class="text-center py-10 text-rose-200">
                        <div class="text-5xl mb-2">üêæ</div>
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á!
                    </div>
                </div>
            </div>
            <!-- Page 1 History -->
            <div class="mt-8 bg-white rounded-[2rem] p-6 shadow-xl border-2 border-rose-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-rose-500 flex items-center">
                        <span class="mr-2">üìÇ</span> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Test Case ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
                    </h2>
                </div>
                <div id="testCaseHistoryList" class="space-y-2">
                    <!-- Historical test case groups will be rendered here -->
                </div>
                <div id="testCaseHistoryEmpty" class="text-center py-6 text-rose-200">
                    <div class="text-3xl mb-1">üìã</div>
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </div>
            </div>
        </div>

        <!-- ==================== PAGE 2: JSON Payload Generator ==================== -->
        <div id="page2" class="hidden">

            <!-- Step 1: Download Template -->
            <div class="cat-card p-8 shadow-2xl mb-8 fade-in">
                <h2 class="text-xl font-bold text-rose-500 mb-4 flex items-center">
                    <span class="text-2xl mr-2">‚ë†</span> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                </h2>
                <p class="text-gray-500 mb-4 text-sm">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà JSON Key-Value ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                    ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤</p>
                <a href="/api/template"
                    class="btn-primary inline-flex items-center px-6 py-3 rounded-full font-bold shadow-lg">
                    üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (Download Template)
                </a>
            </div>

            <!-- Step 2: Upload -->
            <div class="cat-card p-8 shadow-2xl mb-8 fade-in">
                <h2 class="text-xl font-bold text-rose-500 mb-4 flex items-center">
                    <span class="text-2xl mr-2">‚ë°</span> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß
                </h2>
                <div id="uploadZone" class="upload-zone p-10 text-center cursor-pointer">
                    <div class="text-5xl mb-3">üìÇ</div>
                    <p class="text-rose-400 font-medium">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå .xlsx ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                    <p class="text-rose-300 text-sm mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå .xlsx ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                    <input type="file" id="fileInput" accept=".xlsx" class="hidden">
                </div>
                <div id="fileInfo"
                    class="mt-4 hidden bg-green-50 border border-green-200 rounded-xl p-3 flex items-center justify-between">
                    <span class="text-green-600 font-medium text-sm" id="fileName">üìÑ filename.xlsx</span>
                    <button onclick="clearUpload()" class="text-red-400 hover:text-red-600 text-sm font-medium">‚úï
                        ‡∏•‡∏ö</button>
                </div>
            </div>

            <!-- Step 3: Preview Payloads -->
            <div id="payloadSection" class="hidden fade-in">
                <div class="bg-white rounded-[2rem] p-6 shadow-xl border-2 border-rose-100 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-rose-500 flex items-center">
                            <span class="text-2xl mr-2">‚ë¢</span> Payload ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ (<span id="payloadCount">0</span>
                            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                        </h2>
                        <div class="flex space-x-2">
                            <button id="copyAllBtn" onclick="copyAllPayloads()"
                                class="bg-blue-50 text-blue-500 px-4 py-2 rounded-xl text-sm font-medium hover:bg-blue-100 transition-colors">
                                üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </button>
                            <button id="exportPayloadBtn" onclick="exportPayloads()"
                                class="bg-green-100 text-green-600 px-4 py-2 rounded-xl text-sm font-medium hover:bg-green-200 transition-colors">
                                üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô Excel
                            </button>
                        </div>
                    </div>

                    <div id="payloadCards" class="space-y-4">
                        <!-- Payload cards will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Step 4: Upload History -->
            <div class="bg-white rounded-[2rem] p-6 shadow-xl border-2 border-rose-100 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-rose-500 flex items-center">
                        <span class="text-2xl mr-2">‚ë£</span> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (History)
                    </h2>
                    <button onclick="clearHistory()"
                        class="bg-rose-50 text-rose-400 px-4 py-2 rounded-xl text-sm font-medium hover:bg-rose-100 transition-colors">
                        üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                    </button>
                </div>
                <div id="historyList" class="space-y-2">
                    <!-- History items rendered here -->
                </div>
                <div id="historyEmpty" class="text-center py-6 text-rose-200">
                    <div class="text-3xl mb-1">üìÅ</div>
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== Navigation ====================
        function switchPage(page) {
            const page1 = document.getElementById('page1');
            const page2 = document.getElementById('page2');
            const tab1 = document.getElementById('tabPage1');
            const tab2 = document.getElementById('tabPage2');

            if (page === 1) {
                page1.classList.remove('hidden');
                page2.classList.add('hidden');
                tab1.className = 'tab-active px-6 py-3 rounded-full font-bold text-sm transition-all';
                tab2.className = 'tab-inactive px-6 py-3 rounded-full font-bold text-sm transition-all';
            } else {
                page1.classList.add('hidden');
                page2.classList.remove('hidden');
                tab2.className = 'tab-active px-6 py-3 rounded-full font-bold text-sm transition-all';
                tab1.className = 'tab-inactive px-6 py-3 rounded-full font-bold text-sm transition-all';
            }
        }

        // ==================== PAGE 1: Test Case Builder ====================
        const testCaseNameInput = document.getElementById('testCaseName');
        const testStepInput = document.getElementById('testStep');
        const expectedResultInput = document.getElementById('expectedResult');
        const addStepBtn = document.getElementById('addStepBtn');
        const tableBody = document.getElementById('testCaseTableBody');
        const emptyState = document.getElementById('emptyState');
        const resetBtn = document.getElementById('resetBtn');
        const exportBtn = document.getElementById('exportBtn');

        let testCases = [];

        function validateInputs() {
            const hasName = testCaseNameInput.value.trim() !== '';
            const hasStep = testStepInput.value.trim() !== '';
            const hasExpected = expectedResultInput.value.trim() !== '';
            addStepBtn.disabled = !(hasName && hasStep && hasExpected);
        }

        [testCaseNameInput, testStepInput, expectedResultInput].forEach(input => {
            input.addEventListener('input', validateInputs);
        });

        addStepBtn.addEventListener('click', () => {
            testCases.push({
                name: testCaseNameInput.value.trim(),
                step: testStepInput.value.trim(),
                expected: expectedResultInput.value.trim()
            });
            renderTable();
            testStepInput.value = '';
            expectedResultInput.value = '';
            validateInputs();
            testStepInput.focus();
        });



        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.deleteStep = function (index) {
            testCases.splice(index, 1);
            renderTable();
        };

        resetBtn.addEventListener('click', () => {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                testCases = [];
                testCaseNameInput.value = '';
                testStepInput.value = '';
                expectedResultInput.value = '';
                renderTable();
                validateInputs();
            }
        });

        // Import Test Cases from Excel
        async function importTestCases(input) {
            const file = input.files[0];
            if (!file) return;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = new ExcelJS.Workbook();
                await workbook.xlsx.load(arrayBuffer);

                const worksheet = workbook.getWorksheet(1); // Get first sheet
                const newTestCases = [];

                worksheet.eachRow((row, rowNumber) => {
                    if (rowNumber === 1) return; // Skip header

                    const name = row.getCell(2).value;
                    const step = row.getCell(3).value;
                    const expected = row.getCell(4).value;

                    if (name || step || expected) {
                        newTestCases.push({
                            name: name?.toString() || '',
                            step: step?.toString() || '',
                            expected: expected?.toString() || ''
                        });
                    }
                });

                if (newTestCases.length > 0) {
                    if (testCases.length > 0 && confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢)')) {
                        testCases = newTestCases;
                    } else {
                        testCases = [...testCases, ...newTestCases];
                    }
                    renderTable();
                    showToast('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üê±');
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel');
                }
            } catch (error) {
                console.error('Import failed:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå: ' + error.message);
            } finally {
                input.value = ''; // Clear input for next time
            }
        }

        // Page 1 Excel Export (ExcelJS)
        exportBtn.addEventListener('click', async () => {
            try {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Test Cases');
                worksheet.columns = [
                    { header: '‡∏•‡∏≥‡∏î‡∏±‡∏ö', key: 'no', width: 10 },
                    { header: '‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö', key: 'name', width: 30 },
                    { header: '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö', key: 'step', width: 50 },
                    { header: '‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á', key: 'expected', width: 50 }
                ];
                worksheet.getRow(1).font = { bold: true };
                worksheet.getRow(1).alignment = { vertical: 'middle' };
                testCases.forEach((tc, index) => {
                    const row = worksheet.addRow({ no: index + 1, name: tc.name, step: tc.step, expected: tc.expected });
                    row.getCell('step').alignment = { wrapText: true, vertical: 'top' };
                    row.getCell('expected').alignment = { wrapText: true, vertical: 'top' };
                    row.getCell('name').alignment = { vertical: 'top' };
                    row.getCell('no').alignment = { vertical: 'top' };
                });
                const rawName = testCases[0].name || 'test-cases';
                const safeName = rawName.replace(/[\\\/:*?"<>|]/g, '_').trim();
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                saveAs(blob, `Cat_Test_Case_${safeName || 'Export'}.xlsx`);
            } catch (error) {
                console.error('Export failed:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå: ' + error.message);
            }
        });

        // ==================== PAGE 2: JSON Payload Generator ====================
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileNameEl = document.getElementById('fileName');
        const payloadSection = document.getElementById('payloadSection');
        const payloadCards = document.getElementById('payloadCards');
        const payloadCountEl = document.getElementById('payloadCount');

        let generatedPayloads = [];

        // Upload zone click
        uploadZone.addEventListener('click', () => fileInput.click());

        // Drag & drop
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.xlsx')) {
                processFile(file);
            } else {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå .xlsx ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) processFile(e.target.files[0]);
        });

        async function processFile(file) {
            fileNameEl.textContent = 'üìÑ ' + file.name;
            fileInfo.classList.remove('hidden');

            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = new ExcelJS.Workbook();
                await workbook.xlsx.load(arrayBuffer);

                // ---- Nested JSON helper functions ----
                function parsePath(path) {
                    const parts = [];
                    const tokens = path.replace(/\[(\d+)\]/g, '.$1').split('.');
                    tokens.forEach(t => {
                        if (/^\d+$/.test(t)) {
                            parts.push(parseInt(t, 10));
                        } else {
                            parts.push(t);
                        }
                    });
                    return parts;
                }

                function setNestedValue(obj, path, value) {
                    const parts = parsePath(path);
                    let current = obj;
                    for (let i = 0; i < parts.length - 1; i++) {
                        const key = parts[i];
                        const nextKey = parts[i + 1];
                        if (current[key] === undefined) {
                            current[key] = typeof nextKey === 'number' ? [] : {};
                        }
                        current = current[key];
                    }
                    current[parts[parts.length - 1]] = value;
                }

                function parseValue(val) {
                    if (val === 'true') return true;
                    if (val === 'false') return false;
                    if (val === 'null') return null;
                    if (/^-?\d+(\.\d+)?$/.test(val)) return Number(val);
                    return val;
                }

                // ---- Loop through all sheets (skip instruction sheet) ----
                generatedPayloads = [];
                const skippedNames = ['‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', 'instructions'];

                workbook.worksheets.forEach(worksheet => {
                    const sheetName = worksheet.name.toLowerCase().trim();
                    if (skippedNames.some(s => sheetName === s.toLowerCase())) return;

                    const rows = [];
                    worksheet.eachRow((row, rowNumber) => {
                        if (rowNumber === 1) return; // Skip header
                        const key = row.getCell(2).value; // Column B = Key
                        let value = row.getCell(3).value;   // Column C = Value

                        // Handle rich text / formula objects
                        if (value && typeof value === 'object' && value.richText) {
                            value = value.richText.map(rt => rt.text).join('');
                        }
                        if (value && typeof value === 'object' && value.result !== undefined) {
                            value = value.result;
                        }

                        if (key && key.toString().trim()) {
                            rows.push({
                                key: key.toString().trim(),
                                value: value !== null && value !== undefined ? value.toString().trim() : ''
                            });
                        }
                    });

                    if (rows.length === 0) return;

                    // Build nested payload for this sheet
                    const payload = {};
                    rows.forEach(r => {
                        setNestedValue(payload, r.key, parseValue(r.value));
                    });

                    generatedPayloads.push({
                        sheetName: worksheet.name,
                        items: rows,
                        payload
                    });
                });

                if (generatedPayloads.length === 0) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Key-Value ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå');
                    return;
                }

                renderPayloads();
                saveToHistory(file.name, generatedPayloads);
            } catch (error) {
                console.error('File processing error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå: ' + error.message);
            }
        }

        // ==================== Upload History (localStorage) ====================
        const HISTORY_KEY = 'cat_payload_history';

        function getHistory() {
            try {
                return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            } catch { return []; }
        }

        function saveToHistory(fileName, payloads) {
            const history = getHistory();
            history.unshift({
                id: Date.now(),
                fileName,
                date: new Date().toLocaleString('th-TH'),
                payloadCount: payloads.length,
                payloads: payloads
            });
            // Keep max 20 entries
            if (history.length > 20) history.length = 20;
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const historyList = document.getElementById('historyList');
            const historyEmpty = document.getElementById('historyEmpty');
            const history = getHistory();

            historyList.innerHTML = '';
            if (history.length === 0) {
                historyEmpty.classList.remove('hidden');
                return;
            }
            historyEmpty.classList.add('hidden');

            history.forEach((item, idx) => {
                const el = document.createElement('div');
                el.className = 'flex items-center justify-between bg-rose-50/50 rounded-xl px-4 py-3 hover:bg-rose-50 transition-colors';
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-lg">üìÑ</span>
                        <div>
                            <p class="font-medium text-gray-700 text-sm">${escapeHtml(item.fileName)}</p>
                            <p class="text-xs text-gray-400">${item.date} ¬∑ ${item.payloadCount} payload(s)</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadFromHistory(${idx})" class="bg-white text-blue-500 px-3 py-1 rounded-lg text-xs font-medium hover:bg-blue-50 transition-colors border border-blue-200">
                            üëÅÔ∏è ‡∏î‡∏π
                        </button>
                        <button onclick="deleteFromHistory(${idx})" class="bg-white text-red-400 px-3 py-1 rounded-lg text-xs font-medium hover:bg-red-50 transition-colors border border-red-200">
                            ‚úï
                        </button>
                    </div>
                `;
                historyList.appendChild(el);
            });
        }

        window.loadFromHistory = function (idx) {
            const history = getHistory();
            if (!history[idx]) return;
            generatedPayloads = history[idx].payloads;
            fileNameEl.textContent = 'üìÑ ' + history[idx].fileName + ' (‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)';
            fileInfo.classList.remove('hidden');
            renderPayloads();
            showToast('‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìÇ');
        };

        window.deleteFromHistory = function (idx) {
            const history = getHistory();
            history.splice(idx, 1);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            renderHistory();
            showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß');
        };

        function clearHistory() {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            localStorage.removeItem(HISTORY_KEY);
            renderHistory();
            showToast('‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }

        // Render history on page load
        renderHistory();

        // ---- Cat Atmosphere Generator ----
        function createCatAtmosphere() {
            const atmosphere = document.getElementById('cat-atmosphere');
            const catIcons = ['üê±', 'üêà', 'üò∫', 'üêæ', 'üêà‚Äç‚¨õ', 'üêæ', 'üò∏', 'üòª', 'üêæ'];
            const count = 40; // Number of cats

            for (let i = 0; i < count; i++) {
                const cat = document.createElement('div');
                cat.className = 'bg-cat';
                cat.textContent = catIcons[Math.floor(Math.random() * catIcons.length)];

                // Random position
                cat.style.left = Math.random() * 100 + '%';
                cat.style.top = Math.random() * 100 + '%';

                // Random size
                const size = 20 + Math.random() * 60;
                cat.style.fontSize = size + 'px';

                // Random animation delay and duration
                cat.style.animationDelay = (Math.random() * -20) + 's';
                cat.style.animationDuration = (15 + Math.random() * 15) + 's';

                atmosphere.appendChild(cat);
            }
        }
        createCatAtmosphere();

        function clearUpload() {
            fileInput.value = '';
            fileInfo.classList.add('hidden');
            payloadSection.classList.add('hidden');
            generatedPayloads = [];
        }

        function renderPayloads() {
            payloadCards.innerHTML = '';
            payloadCountEl.textContent = generatedPayloads.length;
            payloadSection.classList.remove('hidden');

            // ---- Combined JSON block (when 2+ payloads) ----
            if (generatedPayloads.length > 1) {
                const allPayloads = generatedPayloads.map(e => e.payload);
                const combinedJson = JSON.stringify(allPayloads, null, 2);
                const combinedHighlighted = syntaxHighlight(combinedJson);

                const combinedCard = document.createElement('div');
                combinedCard.className = 'border-2 border-indigo-200 rounded-2xl overflow-hidden fade-in mb-6';
                combinedCard.innerHTML = `
                    <div class="bg-indigo-50 px-5 py-3 flex justify-between items-center">
                        <span class="font-bold text-indigo-500">üì¶ JSON ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${generatedPayloads.length} Payloads)</span>
                        <button onclick="copyCombinedPayloads()" class="bg-white text-indigo-400 px-3 py-1 rounded-lg text-xs font-medium hover:bg-indigo-100 transition-colors border border-indigo-200">
                            üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡∏£‡∏ß‡∏°
                        </button>
                    </div>
                    <div class="px-5 py-4">
                        <pre class="json-block p-4" style="max-height: 400px; overflow-y: auto;">${combinedHighlighted}</pre>
                    </div>
                `;
                payloadCards.appendChild(combinedCard);
            }

            generatedPayloads.forEach((entry, idx) => {
                const jsonStr = JSON.stringify(entry.payload, null, 2);
                const highlighted = syntaxHighlight(jsonStr);

                const card = document.createElement('div');
                card.className = 'border-2 border-rose-100 rounded-2xl overflow-hidden fade-in';
                card.innerHTML = `
                    <div class="bg-rose-50 px-5 py-3 flex justify-between items-center">
                        <span class="font-bold text-rose-500">üê± Payload #${idx + 1} ${entry.sheetName ? `<span class="text-rose-300 font-normal text-sm ml-2">(${escapeHtml(entry.sheetName)})</span>` : ''}</span>
                        <button onclick="copyPayload(${idx})" class="bg-white text-rose-400 px-3 py-1 rounded-lg text-xs font-medium hover:bg-rose-100 transition-colors border border-rose-200">
                            üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                        </button>
                    </div>
                    <!-- Key-Value Table -->
                    <div class="px-5 py-3">
                        <table class="w-full text-sm mb-3">
                            <thead>
                                <tr class="border-b border-rose-50">
                                    <th class="py-2 px-3 text-left text-rose-400 font-semibold w-12">No.</th>
                                    <th class="py-2 px-3 text-left text-rose-400 font-semibold">Key</th>
                                    <th class="py-2 px-3 text-left text-rose-400 font-semibold">Value</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600">
                                ${entry.items.map((item, i) => `
                                    <tr class="border-b border-rose-50/50">
                                        <td class="py-2 px-3">${i + 1}</td>
                                        <td class="py-2 px-3 font-mono text-blue-600">${escapeHtml(item.key)}</td>
                                        <td class="py-2 px-3 font-mono">${escapeHtml(item.value)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <!-- JSON Preview -->
                    <div class="px-5 pb-4">
                        <p class="text-xs text-gray-400 mb-2 font-medium">JSON Payload:</p>
                        <pre class="json-block p-4">${highlighted}</pre>
                    </div>
                `;
                payloadCards.appendChild(card);
            });
        }

        function syntaxHighlight(json) {
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                        match = match.replace(/:$/, '') + ':';
                        return `<span class="${cls}">${match.slice(0, -1)}</span>:`;
                    }
                    cls = 'json-string';
                } else if (/true|false/.test(match)) {
                    cls = 'json-bool';
                }
                return `<span class="${cls}">${match}</span>`;
            });
        }

        window.copyPayload = function (idx) {
            const text = JSON.stringify(generatedPayloads[idx].payload, null, 2);
            navigator.clipboard.writeText(text).then(() => {
                showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Payload ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üê±');
            });
        };

        window.copyCombinedPayloads = function () {
            const allPayloads = generatedPayloads.map(e => e.payload);
            const text = JSON.stringify(allPayloads, null, 2);
            navigator.clipboard.writeText(text).then(() => {
                showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üì¶');
            });
        };

        function copyAllPayloads() {
            const allText = generatedPayloads.map((entry, idx) =>
                `// Payload #${idx + 1}${entry.sheetName ? ' (' + entry.sheetName + ')' : ''}\n${JSON.stringify(entry.payload, null, 2)}`
            ).join('\n\n');
            navigator.clipboard.writeText(allText).then(() => {
                showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üê±');
            });
        }

        async function exportPayloads() {
            try {
                const workbook = new ExcelJS.Workbook();

                generatedPayloads.forEach((entry, pIdx) => {
                    const sheetName = entry.sheetName || `Payload ${pIdx + 1}`;
                    const worksheet = workbook.addWorksheet(sheetName);

                    worksheet.columns = [
                        { header: '‡∏•‡∏≥‡∏î‡∏±‡∏ö', key: 'no', width: 10 },
                        { header: 'Key', key: 'key', width: 30 },
                        { header: 'Value', key: 'value', width: 40 },
                        { header: 'JSON Payload', key: 'payload', width: 60 }
                    ];

                    worksheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
                    worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' };
                    worksheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFDA4AF' } };

                    const jsonStr = JSON.stringify(entry.payload, null, 2);
                    entry.items.forEach((item, i) => {
                        const row = worksheet.addRow({
                            no: i + 1,
                            key: item.key,
                            value: item.value,
                            payload: i === 0 ? jsonStr : ''
                        });
                        row.getCell('payload').alignment = { wrapText: true, vertical: 'top' };
                        row.getCell('key').alignment = { vertical: 'top' };
                        row.getCell('value').alignment = { vertical: 'top' };
                        row.getCell('no').alignment = { vertical: 'top' };
                    });
                });

                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                saveAs(blob, 'Cat_JSON_Payloads.xlsx');
                showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üì•');
            } catch (error) {
                console.error('Export failed:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå: ' + error.message);
            }
        }

        // ==================== AI SIDEBAR LOGIC ====================
        let isAIOpen = false;
        let chatHistory = [];

        window.toggleAI = function () {
            const sidebar = document.getElementById('ai-sidebar');
            const icon = document.getElementById('ai-toggle-icon');
            isAIOpen = !isAIOpen;
            sidebar.style.transform = isAIOpen ? 'translateX(0)' : 'translateX(-100%)';
            icon.textContent = isAIOpen ? '‚úï' : 'üê±';
        };

        window.sendMessage = async function () {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            addChatMessage('user', msg);
            input.value = '';

            // Show typing indicator
            const typingId = addChatMessage('ai', '<span class="typing-dot"></span><span class="typing-dot" style="animation-delay: 0.2s"></span><span class="typing-dot" style="animation-delay: 0.4s"></span>', true);

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg, history: chatHistory })
                });
                const data = await res.json();

                // Remove typing indicator
                document.getElementById(typingId).remove();

                if (data.error) {
                    addChatMessage('ai', '‚ùå ' + data.error);
                } else {
                    if (data.action === 'add_testcases') {
                        testCases = [...testCases, ...data.data];
                        renderTable();
                        addChatMessage('ai', data.message || '‡πÄ‡∏û‡∏¥‡πà‡∏° Test Case ‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö‡πÅ‡∏á‡πâ‡∏ß! üêæ');
                        showToast('AI ‡πÄ‡∏û‡∏¥‡πà‡∏° Test Case ‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß! ‚ú®');
                    } else {
                        addChatMessage('ai', data.message);
                    }

                    // Update internal chat history
                    chatHistory.push({ role: 'user', parts: [{ text: msg }] });
                    chatHistory.push({ role: 'model', parts: [{ text: data.message || '' }] });
                }
            } catch (err) {
                document.getElementById(typingId).remove();
                addChatMessage('ai', '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö‡πÅ‡∏°‡πà‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå ‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏°‡∏ß‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á... üòø');
            }
        };

        function addChatMessage(role, text, isRaw = false) {
            const container = document.getElementById('chat-container');
            const id = 'chat-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = `chat-bubble ${role} shadow-sm fade-in`;
            if (isRaw) div.innerHTML = text;
            else div.textContent = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // ==================== INLINE EDITING LOGIC ====================
        window.updateTestCaseData = function (index, field, value) {
            testCases[index][field] = value.trim();
        };

        // Modify renderTable to add contenteditable
        function renderTable() {
            tableBody.innerHTML = '';
            if (testCases.length === 0) {
                emptyState.classList.remove('hidden');
                exportBtn.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                exportBtn.classList.remove('hidden');
                testCases.forEach((tc, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-rose-50 hover:bg-rose-50/30 transition-colors';
                    row.innerHTML = `
                        <td class="py-4 px-4 font-medium">${index + 1}</td>
                        <td class="py-4 px-4" contenteditable="true" onblur="updateTestCaseData(${index}, 'name', this.innerText)">${escapeHtml(tc.name)}</td>
                        <td class="py-4 px-4 whitespace-pre-line" contenteditable="true" onblur="updateTestCaseData(${index}, 'step', this.innerText)">${escapeHtml(tc.step)}</td>
                        <td class="py-4 px-4 whitespace-pre-line" contenteditable="true" onblur="updateTestCaseData(${index}, 'expected', this.innerText)">${escapeHtml(tc.expected)}</td>
                        <td class="py-4 px-4 text-center">
                            <button onclick="deleteStep(${index})" class="btn-danger w-8 h-8 rounded-full inline-flex items-center justify-center font-bold" title="‡∏•‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô">‚úï</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }

        // ==================== PAGE 1 HISTORY LOGIC ====================
        const TESTCASE_HISTORY_KEY = 'cat_testcase_history';

        window.saveTestCaseHistory = function () {
            if (testCases.length === 0) {
                alert('‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏° Test Case ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏∞‡πÅ‡∏á‡πâ‡∏ß!');
                return;
            }
            const name = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î Test Case ‡∏ô‡∏µ‡πâ:', testCases[0].name || '‡∏ä‡∏∏‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà');
            if (name === null) return;

            const history = JSON.parse(localStorage.getItem(TESTCASE_HISTORY_KEY) || '[]');
            history.unshift({
                id: Date.now(),
                name: name || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',
                date: new Date().toLocaleString('th-TH'),
                data: [...testCases]
            });
            localStorage.setItem(TESTCASE_HISTORY_KEY, JSON.stringify(history));
            renderTestCaseHistory();
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üíæ');
        };

        function renderTestCaseHistory() {
            const list = document.getElementById('testCaseHistoryList');
            const empty = document.getElementById('testCaseHistoryEmpty');
            const history = JSON.parse(localStorage.getItem(TESTCASE_HISTORY_KEY) || '[]');

            list.innerHTML = '';
            if (history.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            history.forEach((item, idx) => {
                const el = document.createElement('div');
                el.className = 'flex items-center justify-between bg-white border-2 border-rose-50 rounded-xl px-4 py-3 hover:border-rose-200 transition-all shadow-sm';
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-xl">üìã</span>
                        <div>
                            <p class="font-bold text-gray-700 text-sm">${escapeHtml(item.name)}</p>
                            <p class="text-xs text-gray-400">${item.date} ¬∑ ${item.data.length} ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadTestCaseFromHistory(${idx})" class="bg-rose-50 text-rose-500 px-3 py-1 rounded-lg text-xs font-bold hover:bg-rose-100 transition-colors">
                            üìÇ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                        <button onclick="deleteTestCaseHistory(${idx})" class="text-gray-300 hover:text-red-400 p-1 transition-colors">
                            ‚úï
                        </button>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        window.loadTestCaseFromHistory = function (idx) {
            const history = JSON.parse(localStorage.getItem(TESTCASE_HISTORY_KEY) || '[]');
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                testCases = [...history[idx].data];
                renderTable();
                showToast('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üêæ');
            }
        };

        window.deleteTestCaseHistory = function (idx) {
            if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ?')) return;
            const history = JSON.parse(localStorage.getItem(TESTCASE_HISTORY_KEY) || '[]');
            history.splice(idx, 1);
            localStorage.setItem(TESTCASE_HISTORY_KEY, JSON.stringify(history));
            renderTestCaseHistory();
        };

        renderTestCaseHistory();

        // Toast notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-6 right-6 bg-gray-800 text-white px-6 py-3 rounded-xl shadow-2xl text-sm font-medium z-50 fade-in';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }
    </script>
</body>

</html>